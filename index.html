<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MFN 2026 Band Management</title>
    <style>
        :root {
            --color-teal: #21808d;
            --color-red: #c0152f;
            --color-slate: #13343b;
            --color-border: rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, Helvetica, Arial, sans-serif; background: #fcfcf9; color: #13343b; }
        
        .header { background: white; border-bottom: 1px solid var(--color-border); padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-size: 20px; font-weight: bold; color: var(--color-teal); margin: 0; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }

        .user-selection { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; padding: 30px 0; }
        .user-card { background: white; border: 2px solid #ddd; border-radius: 12px; padding: 25px; cursor: pointer; text-align: center; width: 180px; margin-bottom: 10px; }
        .user-card:hover { border-color: var(--color-teal); }
        .user-card-icon { font-size: 40px; margin-bottom: 10px; }
        .user-card-name { font-weight: 600; font-size: 14px; }

        .tabs { display: flex; background: white; border-bottom: 1px solid #ddd; overflow-x: auto; }
        .tab { padding: 15px 20px; cursor: pointer; border: none; background: none; font-weight: 600; color: #666; white-space: nowrap; }
        .tab.active { color: var(--color-teal); border-bottom: 3px solid var(--color-teal); }

        .page { display: none; padding: 20px 0; }
        .page.active { display: block; }

        .card { background: white; border-radius: 12px; padding: 20px; border: 1px solid #eee; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .form-grid { display: flex; flex-wrap: wrap; gap: 15px; }
        .form-group { flex: 1; min-width: 240px; display: flex; flex-direction: column; margin-bottom: 15px; }
        .form-label { font-size: 11px; font-weight: bold; margin-bottom: 5px; color: #555; text-transform: uppercase; }
        .form-control { padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; background: white; -webkit-appearance: none; }

        .btn { padding: 12px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 13px; text-align: center; display: inline-block; }
        .btn-primary { background: var(--color-teal); color: white; }
        .btn-secondary { background: #eee; color: #333; }
        .btn-danger { background: var(--color-red); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 11px; }

        .table-container { background: white; border-radius: 12px; overflow-x: auto; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #f4f4f4; padding: 12px; font-size: 11px; text-align: left; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; }

        .bands-grid { display: flex; flex-wrap: wrap; gap: 10px; margin: 20px 0; }
        .band-block { border: 2px solid var(--color-teal); border-radius: 8px; padding: 5px; text-align: center; width: 100px; background: white; }
        .band-block input { width: 100%; border: none; text-align: center; font-size: 16px; font-weight: bold; color: var(--color-teal); outline: none; }
        .band-block-label { font-size: 8px; font-weight: bold; color: #999; text-transform: uppercase; margin-top: 2px; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 25px; width: 95%; max-width: 500px; }

        .toast { position: fixed; bottom: 30px; right: 30px; padding: 15px 25px; border-radius: 10px; z-index: 2000; color: white; display: none; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3); min-width: 260px; }
        .toast.error { background: var(--color-red); }
        .toast.success { background: var(--color-teal); }

        .summary-cards { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
        .stat-card { flex: 1; min-width: 200px; background: white; padding: 20px; border-radius: 12px; text-align: center; border-top: 4px solid var(--color-teal); border: 1px solid #ddd; }
        .stat-value { font-size: 28px; font-weight: 800; color: var(--color-teal); }
        
        .manage-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .admin-badge { background: #e0f2f1; color: #00796b; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; display: inline-block; margin-bottom: 4px; }
    </style>
</head>
<body>

    <div id="loginScreen" class="container">
        <h1 style="text-align: center; margin-top: 40px; color: var(--color-teal);">MFN 2026 Band Management</h1>
        <p id="selectionPath" style="text-align: center; font-weight: bold; color: #666;"></p>
        <div id="userSelectionGrid" class="user-selection"></div>
    </div>

    <div id="mainApp" style="display: none;">
        <div class="header">
            <h1 class="header-title">MFN 2026</h1>
            <div style="display: flex; align-items: center;">
                <span id="currentUserDisplay" style="margin-right:15px; font-weight:bold; font-size: 13px;"></span>
                <button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" id="tab-entry" onclick="showPage('entryPage')">Entry Form</div>
            <div class="tab" id="tab-data" onclick="showPage('dataPage')">Explorer</div>
            <div class="tab" id="adminTab" style="display: none;" onclick="showPage('adminPage')">Settings</div>
        </div>

        <div class="container">
            <div id="entryPage" class="page active">
                <div class="card">
                    <h2 style="margin-top:0">Record New Entry</h2>
                    <div class="form-group">
                        <label class="form-label">Starting Band #</label>
                        <input type="number" id="startBand" class="form-control" placeholder="e.g. 1001" oninput="updateBandPreview()">
                    </div>
                    <form id="entryForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Recipient Name</label>
                                <input type="text" id="recName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Zone</label>
                                <select id="recZone" class="form-control" required onchange="populateCommunities('recComm', this.value)">
                                    <option value="">Select Zone</option>
                                    <option value="1">Zone 1</option><option value="2">Zone 2</option>
                                    <option value="3A">Zone 3A</option><option value="3B">Zone 3B</option>
                                    <option value="4A">Zone 4A</option><option value="4B">Zone 4B</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Community</label>
                                <select id="recComm" class="form-control" required></select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Quantity</label>
                                <input type="number" id="qty" class="form-control" min="1" placeholder="Enter qty" oninput="updateBandPreview()">
                            </div>
                        </div>
                        <p style="font-size:10px; font-weight:bold; color:#666; margin-bottom:10px;">BAND MAP (CLICK NUMBERS TO EDIT):</p>
                        <div id="bandsPreview" class="bands-grid"></div>
                        <div style="background: #13343b; color: white; padding: 20px; border-radius: 12px; display: flex; justify-content: space-between; margin: 20px 0; align-items: center;">
                            <div>
                                <div style="font-size: 10px; opacity: 0.7; font-weight: bold;">TOTAL DUE</div>
                                <div id="qtySummary" style="font-size: 14px;">0 bands</div>
                            </div>
                            <div style="font-size: 28px; font-weight: bold; color: #4db6ac;">‚Çπ<span id="calcTotal">0</span></div>
                        </div>
                        <button type="submit" id="saveEntryBtn" class="btn btn-primary" style="width: 100%">Save Entry</button>
                    </form>
                </div>
            </div>

            <div id="dataPage" class="page">
                <div class="summary-cards">
                    <div class="stat-card"><div class="stat-value" id="totalEntriesDisplay">0</div><div style="font-size:11px; font-weight:bold;">ENTRIES</div></div>
                    <div class="stat-card"><div class="stat-value">‚Çπ<span id="totalRevenueDisplay">0</span></div><div style="font-size:11px; font-weight:bold;">REVENUE</div></div>
                </div>
                <div class="card">
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Search Name/Band</label><input type="text" id="search" class="form-control" onkeyup="filterTable()"></div>
                        <div class="form-group"><label class="form-label">Date Filter</label><input type="date" id="dateFilter" class="form-control" onchange="filterTable()"></div>
                        <div class="form-group">
                            <label class="form-label">Sorting</label>
                            <select id="sortBy" class="form-control" onchange="filterTable()">
                                <option value="date-desc">Newest First</option>
                                <option value="band-asc">Band # (Low to High)</option>
                                <option value="name-asc">Name (A-Z)</option>
                            </select>
                        </div>
                    </div>
                    <div id="adminFilters" style="display:none; border-top: 1px solid #eee; padding-top:15px; margin-top:10px;">
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Category</label><select id="fCat" class="form-control" onchange="filterTable()"><option value="all">All</option><option value="Zone">Zone</option><option value="Desk">Desk</option><option value="Church Office">Office</option></select></div>
                            <div class="form-group"><label class="form-label">Operator</label><select id="fOper" class="form-control" onchange="filterTable()"><option value="all">All</option></select></div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-secondary btn-sm" onclick="exportCSV()">Export CSV</button>
                        <button class="btn btn-secondary btn-sm" onclick="loadEntries()">Refresh</button>
                    </div>
                    <div class="table-container" style="margin-top: 20px;">
                        <table>
                            <thead><tr><th>Band #</th><th>Name</th><th>Zone</th><th>Community</th><th>Amount</th><th>Date</th><th id="adminCol" style="display:none">Operator</th><th>Actions</th></tr></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="adminPage" class="page">
                <div class="card">
                    <h3>Account Management</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="openModal('addUserModal')">Create New Profile</button>
                        <button class="btn btn-secondary" onclick="renderUserList()">Manage Users</button>
                    </div>
                    <hr style="opacity:0.1">
                    <h3 style="color: var(--color-red)">System Database</h3>
                    <button class="btn btn-danger" onclick="clearDatabase()">Wipe Entries Database</button>
                </div>
            </div>
        </div>
    </div>

    <div id="passwordModal" class="modal"><div class="modal-content"><h2 id="loginTitle" style="margin-top:0">Login</h2><div class="form-group"><label class="form-label">Password</label><input type="password" id="loginPass" class="form-control"></div><div style="margin-top: 20px; display: flex; gap: 10px;"><button class="btn btn-primary" onclick="processLogin()" style="flex:1">Login</button><button class="btn btn-secondary" onclick="closeModal('passwordModal')" style="flex:1">Cancel</button></div></div></div>

    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top:0">Create User</h2>
            <div class="form-group"><label class="form-label">Category</label><select id="newRole" class="form-control" onchange="handleRoleChange(this.value)"><option value="Desk">Desk</option><option value="Church Office">Church Office</option><option value="Zone">Zone</option></select></div>
            <div id="zoneSubField" class="form-group" style="display:none"><label class="form-label">Select Zone Group</label><select id="newUserZone" class="form-control" onchange="populateCommunityUsernames(this.value)"></select></div>
            <div class="form-group" id="unameContainer"></div>
            <div class="form-group" id="passContainer"></div>
            <div class="form-group" id="viewerField" style="display:none; flex-direction:row; align-items:center; gap:10px;">
                <input type="checkbox" id="isViewer" style="width:20px; height:20px;">
                <label class="form-label" style="margin:0">Viewer Account (Can view all data but not enter)</label>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-primary" style="flex:1" onclick="submitUser()">Save Profile</button>
                <button class="btn btn-secondary" style="flex:1" onclick="closeModal('addUserModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="userManageModal" class="modal"><div class="modal-content" style="max-width: 600px;"><h2 style="margin-top:0">System Profiles</h2><div id="userListBody" style="max-height: 350px; overflow-y: auto; border:1px solid #eee; border-radius:8px;"></div><button class="btn btn-secondary" style="margin-top:20px; width:100%" onclick="closeModal('userManageModal')">Close</button></div></div>

    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top:0">Modify User</h2>
            <input type="hidden" id="editUserId">
            <div class="form-group"><label class="form-label">Tag (Category)</label><select id="editProfileRole" class="form-control"><option value="Desk">Desk</option><option value="Church Office">Church Office</option><option value="Zone">Zone</option></select></div>
            <div class="form-group"><label class="form-label">Username</label><input type="text" id="editProfileName" class="form-control"></div>
            <div class="form-group" style="margin-top:10px"><label class="form-label">Password</label><input type="text" id="editProfilePass" class="form-control"></div>
            <div class="form-group" id="editViewerField" style="flex-direction:row; align-items:center; gap:10px; margin-top:10px;">
                <input type="checkbox" id="editIsViewer" style="width:20px; height:20px;">
                <label class="form-label" style="margin:0">Viewer Account</label>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-primary" style="flex:1" onclick="saveUserProfile()">Update</button>
                <button class="btn btn-secondary" style="flex:1" onclick="closeModal('editProfileModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="editEntryModal" class="modal"><div class="modal-content"><h2>Edit Allocation</h2><input type="hidden" id="editEntryId"><div class="form-group"><label class="form-label">Band #</label><input type="number" id="eBand" class="form-control"></div><div class="form-group"><label class="form-label">Recipient Name</label><input type="text" id="eName" class="form-control"></div><div style="display:flex; gap:10px; margin-top:20px;"><button class="btn btn-primary" onclick="submitEntryUpdate()" style="flex:1">Update</button><button class="btn btn-secondary" onclick="closeModal('editEntryModal')" style="flex:1">Cancel</button></div></div></div>

    <div id="forcePassModal" class="modal"><div class="modal-content"><h2>Security Update</h2><p>Please create a unique password to continue.</p><input type="password" id="newSecurePass" class="form-control" placeholder="New Password"><button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="applyForceChange()">Save Password</button></div></div>

    <div id="toast" class="toast"></div>

    <script>
        var API_URL = '/api';
        var communitiesMap = {
            '1': ['Morning Star', 'St. Andrew', 'Holy Trinity', 'St. Ann & St. Michael', 'Divya Jyothi', 'Unknown'],
            '2': ['Our Lady of Velankani', 'St. Anne', 'St. John', 'Holy Cross', 'St. Sebastian', 'Immaculate Conception', 'Unknown'],
            '3A': ['Divine Angel', 'Ave Maria', 'Unknown'],
            '3B': ['Our Lady of Rosary', 'Our Lady of Nazareth', 'Mother Theresa', 'St. Thomas', 'St. Francis Xavier', 'St. Anthony', 'Holy Cross', 'Unknown'],
            '4A': ['Gonsalo Gracia', 'Servers', 'St. Luke', 'St. Theresa', 'Don Bosco', 'Unknown'],
            '4B': ['St. Joseph', 'St. Anthony', 'St. Peter', 'Dominic Savio', 'Unknown'],
            'Other': ['External', 'Other', 'Unknown']
        };

        var appState = { user: null, isAdmin: false, isViewer: false, users: {}, entries: [], loginCat: null, loginZone: null, filtered: [] };

        function init() {
            fetch(API_URL + '/manage-users')
                .then(function(res) { return res.json(); })
                .then(function(result) {
                    appState.users = {};
                    if (result.data) {
                        result.data.forEach(function(u) { appState.users[u.username] = u; });
                    }
                    renderSelection();
                    handleRoleChange('Desk');
                });
        }

        function renderSelection() {
            var grid = document.getElementById('userSelectionGrid');
            var path = document.getElementById('selectionPath');
            grid.innerHTML = '';
            if (!appState.loginCat) {
                path.innerText = "Select Category";
                var root = [{id:'Zone', icon:'üìç'}, {id:'Desk', icon:'üñ•Ô∏è'}, {id:'Church Office', icon:'‚õ™'}, {id:'Admin', icon:'üîê'}];
                root.forEach(function(c) {
                    var card = document.createElement('div');
                    card.className = 'user-card';
                    card.onclick = function() { if(c.id === 'Admin') openLogin('admin'); else { appState.loginCat = c.id; renderSelection(); } };
                    card.innerHTML = '<div class="user-card-icon">'+c.icon+'</div><div class="user-card-name">'+c.id+'</div>';
                    grid.appendChild(card);
                });
            } else if (appState.loginCat === 'Zone' && !appState.loginZone) {
                path.innerText = "Select Zone Group";
                ['1','2','3A','3B','4A','4B'].forEach(function(z) {
                    var card = document.createElement('div');
                    card.className = 'user-card';
                    card.onclick = function() { appState.loginZone = z; renderSelection(); };
                    card.innerHTML = '<div class="user-card-icon">üö©</div><div class="user-card-name">Zone '+z+'</div>';
                    grid.appendChild(card);
                });
                addBack();
            } else {
                path.innerText = "Select ID Profile";
                var usernames = Object.keys(appState.users);
                usernames.forEach(function(uname) {
                    var u = appState.users[uname];
                    var match = (appState.loginCat === 'Zone') ? (u.role === 'Zone' && u.userZone === appState.loginZone) : (u.role === appState.loginCat);
                    if (match && !u.isAdmin) {
                        var card = document.createElement('div');
                        card.className = 'user-card';
                        card.onclick = function() { openLogin(uname); };
                        card.innerHTML = '<div class="user-card-icon">üë§</div><div class="user-card-name">'+uname+'</div>';
                        grid.appendChild(card);
                    }
                });
                addBack();
            }
        }

        function addBack() {
            var btn = document.createElement('button');
            btn.className = 'btn btn-secondary';
            btn.style.width = '200px';
            btn.style.marginTop = '20px';
            btn.innerText = '‚Üê Back';
            btn.onclick = function() { if(appState.loginZone) appState.loginZone = null; else appState.loginCat = null; renderSelection(); };
            document.getElementById('userSelectionGrid').appendChild(btn);
        }

        function openLogin(u) {
            document.getElementById('loginTitle').innerText = 'Login: ' + u;
            document.getElementById('loginPass').dataset.target = u;
            document.getElementById('loginPass').value = '';
            openModal('passwordModal');
        }

        function processLogin() {
            var target = document.getElementById('loginPass').dataset.target;
            var pass = document.getElementById('loginPass').value;
            var userObj = appState.users[target];
            if (target === 'admin' && pass === 'admin123') {
                appState.user = 'admin'; appState.isAdmin = true; appState.isViewer = false; finishLogin();
            } else if (userObj && userObj.password === pass) {
                appState.user = target; 
                appState.isAdmin = false;
                appState.isViewer = userObj.isViewer || false;
                closeModal('passwordModal');
                if (pass === 'olep@2026') openModal('forcePassModal'); else finishLogin();
            } else {
                showToast("Incorrect Password", true);
            }
        }

        function finishLogin() {
            closeModal('passwordModal');
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('currentUserDisplay').innerText = 'Operator: ' + appState.user;
            document.getElementById('adminTab').style.display = appState.isAdmin ? 'block' : 'none';
            document.getElementById('adminFilters').style.display = (appState.isAdmin || appState.isViewer) ? 'block' : 'none';
            
            if (appState.isViewer) {
                document.getElementById('tab-entry').style.display = 'none';
                showPage('dataPage');
            } else if (appState.isAdmin) {
                showPage('dataPage');
            } else {
                showPage('entryPage');
            }
            if (appState.isAdmin || appState.isViewer) populateOperatorFilter();
            loadEntries();
        }

        function loadEntries() {
            var scope = (appState.isAdmin || appState.isViewer) ? 'all' : appState.user;
            fetch(API_URL + '/get-entries?userId=' + scope)
                .then(function(res) { return res.json(); })
                .then(function(result) {
                    appState.entries = result.data || [];
                    filterTable();
                });
        }

        function filterTable() {
            var s = document.getElementById('search').value.toLowerCase();
            var d = document.getElementById('dateFilter').value;
            var filtered = appState.entries.filter(function(e) {
                var searchMatch = e.name.toLowerCase().indexOf(s) > -1 || e.bandNo.toString().indexOf(s) > -1;
                var dateMatch = !d || e.createdAt.indexOf(d) === 0;
                if (appState.isAdmin || appState.isViewer) {
                    var cat = document.getElementById('fCat').value;
                    var oper = document.getElementById('fOper').value;
                    var uObj = appState.users[e.userId] || {};
                    if (cat !== 'all' && uObj.role !== cat) return false;
                    if (oper !== 'all' && e.userId !== oper) return false;
                }
                return searchMatch && dateMatch;
            });
            appState.filtered = filtered;
            renderTable(filtered);
        }

        function renderTable(data) {
            var tb = document.getElementById('tableBody');
            document.getElementById('adminCol').style.display = (appState.isAdmin || appState.isViewer) ? 'table-cell' : 'none';
            var sort = document.getElementById('sortBy').value;
            if (sort === 'date-desc') data.sort(function(a,b) { return new Date(b.createdAt) - new Date(a.createdAt); });
            if (sort === 'band-asc') data.sort(function(a,b) { return a.bandNo - b.bandNo; });
            if (sort === 'name-asc') data.sort(function(a,b) { return a.name.localeCompare(b.name); });
            var html = '';
            data.forEach(function(e) {
                var opCell = (appState.isAdmin || appState.isViewer) ? '<td><span class="admin-badge">' + (appState.users[e.userId] ? appState.users[e.userId].role : '') + '</span><br>' + e.userId + '</td>' : '';
                var actionBtn = appState.isViewer ? '<td>-</td>' : '<td><div style="display:flex; gap:5px;"><button class="btn btn-sm btn-secondary" onclick="openEdit(\''+e._id+'\','+e.bandNo+',\''+e.name+'\')">Edit</button><button class="btn btn-sm btn-danger" onclick="deleteEntry(\''+e._id+'\')">Del</button></div></td>';
                html += '<tr><td><strong>#'+e.bandNo+'</strong></td><td>'+e.name+'</td><td>'+e.zone+'</td><td>'+e.community+'</td><td>‚Çπ'+e.amount+'</td><td>'+e.createdAt.substr(0,10)+'</td>'+opCell+actionBtn+'</tr>';
            });
            tb.innerHTML = html || '<tr><td colspan="8" style="text-align:center">No records.</td></tr>';
            document.getElementById('totalEntriesDisplay').innerText = data.length;
            var total = 0; data.forEach(function(i) { total += (i.amount || 0); });
            document.getElementById('totalRevenueDisplay').innerText = total.toLocaleString();
        }

        function updateBandPreview() {
            var start = parseInt(document.getElementById('startBand').value) || 0;
            var q = parseInt(document.getElementById('qty').value) || 0;
            var container = document.getElementById('bandsPreview');
            container.innerHTML = '';
            for(var i=0; i<q; i++) {
                var block = document.createElement('div');
                block.className = 'band-block';
                block.innerHTML = '<input type="number" value="' + (start+i) + '" onchange="checkBandConflict(this)"><div class="band-block-label">BAND #</div>';
                container.appendChild(block);
            }
            document.getElementById('calcTotal').innerText = (q * 50).toLocaleString();
            document.getElementById('qtySummary').innerText = q + ' bands √ó ‚Çπ50';
        }

        function checkBandConflict(input) {
            var val = parseInt(input.value);
            // Check locally first
            var allInputs = document.querySelectorAll('.band-block input');
            var matchCount = 0;
            for(var i=0; i<allInputs.length; i++) {
                if(parseInt(allInputs[i].value) === val) matchCount++;
            }
            if(matchCount > 1) {
                showToast("Duplicate number in current list!", true);
                input.style.borderColor = 'red';
            } else {
                input.style.borderColor = '';
            }
        }

        document.getElementById('entryForm').onsubmit = function(e) {
            e.preventDefault();
            if(appState.isViewer) return;
            var q = parseInt(document.getElementById('qty').value);
            if (!q) { showToast("Enter quantity", true); return; }

            var bandInputs = document.querySelectorAll('.band-block input');
            var bands = [];
            for(var i=0; i<bandInputs.length; i++) {
                bands.push(parseInt(bandInputs[i].value));
            }

            var payload = { userId: appState.user, name: document.getElementById('recName').value, zone: document.getElementById('recZone').value, community: document.getElementById('recComm').value, bands: bands, amountPerBand: 50 };
            fetch(API_URL + '/save-entry', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) })
                .then(function(res) {
                    if (res.status === 409) {
                        return res.json().then(function(data) {
                            showToast("Conflict! Band #" + data.duplicateBands[0].bandNo + " already exists in database.", true);
                        });
                    } else {
                        showToast("Saved Successfully", false);
                        document.getElementById('entryForm').reset();
                        document.getElementById('startBand').value = Math.max.apply(null, bands) + 1;
                        updateBandPreview();
                        loadEntries();
                    }
                });
        };

        function handleRoleChange(r) {
            var sub = document.getElementById('zoneSubField');
            var uCont = document.getElementById('unameContainer');
            var pCont = document.getElementById('passContainer');
            var view = document.getElementById('viewerField');
            
            view.style.display = (r === 'Church Office') ? 'flex' : 'none';
            
            if (r === 'Zone') {
                sub.style.display = 'block';
                document.getElementById('newUserZone').innerHTML = '<option value="">Select Zone Group</option>' + ['1','2','3A','3B','4A','4B'].map(function(v){return '<option value="'+v+'">'+v+'</option>';}).join('');
                uCont.innerHTML = '<label class="form-label">Profile Community</label><select id="newUnameSelect" class="form-control"></select>';
                pCont.innerHTML = '<p style="font-size:11px; color:#666; margin-top:10px;">Default password: olep@2026</p>';
            } else {
                sub.style.display = 'none';
                uCont.innerHTML = '<label class="form-label">Username</label><input type="text" id="newUnameInput" class="form-control">';
                pCont.innerHTML = '<label class="form-label">Manual Password</label><input type="text" id="newPassInput" class="form-control">';
            }
        }

        function populateCommunityUsernames(z) {
            var s = document.getElementById('newUnameSelect');
            if(!s) return;
            s.innerHTML = '<option value="">Select Community</option>';
            if(communitiesMap[z]) {
                communitiesMap[z].forEach(function(c){ s.innerHTML += '<option value="'+c+'">'+c+'</option>'; });
            }
        }

        function submitUser() {
            var role = document.getElementById('newRole').value;
            var uname = (role === 'Zone') ? document.getElementById('newUnameSelect').value : document.getElementById('newUnameInput').value;
            var pass = (role === 'Zone') ? 'olep@2026' : document.getElementById('newPassInput').value;
            var isView = document.getElementById('isViewer').checked;
            var z = document.getElementById('newUserZone').value;
            if(!uname || !pass) { showToast("All fields required", true); return; }
            var p = { username: uname, role: role, userZone: z || null, password: pass, isViewer: isView };
            fetch(API_URL + '/manage-users', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(p) })
                .then(function() { showToast("User Created", false); closeModal('addUserModal'); init(); });
        }

        function renderUserList() {
            fetch(API_URL + '/manage-users')
                .then(function(r){ return r.json(); })
                .then(function(d){
                    var body = document.getElementById('userListBody');
                    body.innerHTML = '';
                    d.data.forEach(function(u) {
                        if(u.isAdmin) return;
                        var row = document.createElement('div');
                        row.className = 'manage-row';
                        row.innerHTML = '<div class="manage-info"><strong>' + u.username + '</strong> (' + u.role + ') ' + (u.isViewer ? '[Viewer]' : '') + '</div><div class="manage-btns"><button class="btn btn-sm btn-secondary" onclick="openProfileEdit(\''+u._id+'\',\''+u.username+'\',\''+u.password+'\',\''+u.role+'\','+u.isViewer+')">Edit</button><button class="btn btn-sm btn-danger" onclick="deleteUser(\''+u.username+'\')">Del</button></div>';
                        body.appendChild(row);
                    });
                    openModal('userManageModal');
                });
        }

        function deleteUser(uname) {
            if(!confirm('Delete '+uname+' and all their records?')) return;
            fetch(API_URL + '/manage-users?username=' + uname, { method: 'DELETE' })
                .then(function(){ showToast("Deleted Profile", false); renderUserList(); init(); });
        }

        function openProfileEdit(id, n, p, r, v) {
            document.getElementById('editUserId').value = id;
            document.getElementById('editProfileName').value = n;
            document.getElementById('editProfilePass').value = p;
            document.getElementById('editProfileRole').value = r;
            document.getElementById('editIsViewer').checked = v;
            document.getElementById('editViewerField').style.display = (r === 'Church Office') ? 'flex' : 'none';
            openModal('editProfileModal');
        }

        function saveUserProfile() {
            var payload = { id: document.getElementById('editUserId').value, username: document.getElementById('editProfileName').value, password: document.getElementById('editProfilePass').value, role: document.getElementById('editProfileRole').value, isViewer: document.getElementById('editIsViewer').checked };
            fetch(API_URL + '/manage-users', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
                .then(function() { showToast("Profile Updated", false); closeModal('editProfileModal'); renderUserList(); init(); });
        }

        function populateOperatorFilter() {
            var s = document.getElementById('fOper');
            s.innerHTML = '<option value="all">All Operators</option>';
            Object.keys(appState.users).forEach(function(u) { if(!appState.users[u].isAdmin) s.innerHTML += '<option value="'+u+'">'+u+'</option>'; });
        }

        function applyForceChange() {
            var np = document.getElementById('newSecurePass').value;
            if(np.length < 4) { showToast("Too short", true); return; }
            fetch(API_URL + '/manage-users', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ id: appState.users[appState.user]._id, password: np }) })
                .then(function(){ showToast("Security Updated", false); closeModal('forcePassModal'); finishLogin(); });
        }

        function exportCSV() {
            if(appState.filtered.length === 0) return showToast("No data to export", true);
            var csv = "\ufeffBand #,Recipient,Zone,Community,Amount,Date,Operator\n";
            appState.filtered.forEach(function(e) { csv += e.bandNo + ',"' + e.name + '",' + e.zone + ',"' + e.community + '",' + e.amount + ',' + e.createdAt.substr(0,10) + ',' + e.userId + '\n'; });
            var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.setAttribute("download", "MFN2026_Report.csv"); document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function showToast(m, err) { var t = document.getElementById('toast'); t.innerText = m; t.className = 'toast ' + (err ? 'error' : 'success'); t.style.display = 'block'; setTimeout(function(){ t.style.display = 'none'; }, 4000); }
        function showPage(pId) {
            document.querySelectorAll('.page').forEach(function(p){ p.classList.remove('active'); });
            document.getElementById(pId).classList.add('active');
            document.querySelectorAll('.tab').forEach(function(t){ t.classList.remove('active'); });
            document.getElementById('tab-' + pId.replace('Page', '')).classList.add('active');
            if(pId === 'dataPage') loadEntries();
        }
        function populateCommunities(id, z) { var s = document.getElementById(id); s.innerHTML = '<option value="">Select Profile</option>'; if(communitiesMap[z]) communitiesMap[z].forEach(function(c){ s.innerHTML += '<option value="'+c+'">'+c+'</option>'; }); }
        function openEdit(id, b, n) { document.getElementById('editEntryId').value = id; document.getElementById('eBand').value = b; document.getElementById('eName').value = n; openModal('editEntryModal'); }
        function submitEntryUpdate() { var p = { id: document.getElementById('editEntryId').value, newBandNo: parseInt(document.getElementById('eBand').value), name: document.getElementById('eName').value, amount: 50 }; fetch(API_URL + '/update-entry', { method: 'PUT', body: JSON.stringify(p), headers: {'Content-Type':'application/json'} }).then(function() { closeModal('editEntryModal'); loadEntries(); showToast("Updated", false); }); }
        function deleteEntry(id) { if(!confirm("Delete?")) return; fetch(API_URL + '/delete-entry?id=' + id, { method: 'DELETE' }).then(function() { loadEntries(); showToast("Deleted", false); }); }
        function clearDatabase() { if(prompt("Enter 'admin123' to wipe:") !== 'admin123') return; fetch(API_URL + '/delete-entry?userId=all', { method: 'DELETE' }).then(function() { loadEntries(); showToast("Database Wiped", false); }); }
        function logout() { window.location.reload(); }

        window.onload = init;
    </script>
</body>
</html>