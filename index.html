<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Band Entry Management System</title>
    <style>
        :root {
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);

            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-red-400-rgb: 255, 84, 89;

            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            --color-error: var(--color-red-500);
            --color-success: var(--color-teal-500);
            --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);

            --font-family-base: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-md: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 550;
            --font-weight-bold: 600;
            --line-height-tight: 1.2;
            --line-height-normal: 1.5;
            --letter-spacing-tight: -0.01em;

            --space-2: 2px;
            --space-4: 4px;
            --space-6: 6px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;

            --radius-sm: 6px;
            --radius-base: 8px;
            --radius-md: 10px;
            --radius-lg: 12px;
            --radius-full: 9999px;

            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04);
            --duration-fast: 150ms;
            --duration-normal: 250ms;
            --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family-base);
            background-color: var(--color-background);
            color: var(--color-text);
        }

        body {
            min-height: 100vh;
        }

        .header {
            background: white;
            border-bottom: 1px solid var(--color-border);
            padding: var(--space-16);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            margin: 0;
        }

        .header-right {
            display: flex;
            gap: var(--space-12);
            align-items: center;
        }

        .user-switch {
            background: var(--color-secondary);
            border: none;
            padding: var(--space-8) var(--space-16);
            border-radius: var(--radius-base);
            cursor: pointer;
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            transition: all var(--duration-fast);
        }

        .user-switch:hover {
            background: var(--color-secondary-hover);
        }

        .user-indicator {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-16);
        }

        .user-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-16);
            padding: var(--space-32);
        }

        .user-card {
            background: white;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-20);
            cursor: pointer;
            transition: all var(--duration-normal);
            text-align: center;
        }

        .user-card:hover {
            border-color: var(--color-primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .user-card-icon {
            font-size: 2.5rem;
            margin-bottom: var(--space-12);
        }

        .user-card-name {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            margin: 0;
        }

        .user-card-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin-top: var(--space-4);
        }

        .tabs {
            display: flex;
            gap: var(--space-2);
            border-bottom: 2px solid var(--color-border);
            background: white;
            padding: 0 var(--space-16);
        }

        .tab {
            background: none;
            border: none;
            padding: var(--space-12) var(--space-16);
            cursor: pointer;
            font-size: var(--font-size-base);
            color: var(--color-text-secondary);
            border-bottom: 3px solid transparent;
            transition: all var(--duration-fast);
            margin-bottom: -2px;
        }

        .tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab:hover {
            color: var(--color-text);
        }

        .page {
            display: none;
            animation: fadeIn var(--duration-normal);
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .form-section {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            margin-bottom: var(--space-20);
            border: 1px solid var(--color-card-border);
        }

        .form-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            margin: 0 0 var(--space-20) 0;
            color: var(--color-primary);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-16);
            margin-bottom: var(--space-20);
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            margin-bottom: var(--space-6);
            color: var(--color-text);
        }

        .form-label.required::after {
            content: ' *';
            color: var(--color-error);
        }

        .form-control {
            padding: var(--space-8) var(--space-12);
            font-size: var(--font-size-base);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            background: var(--color-surface);
            color: var(--color-text);
            font-family: var(--font-family-base);
            transition: all var(--duration-fast);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-focus-ring);
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right var(--space-12) center;
            background-size: 16px;
            padding-right: var(--space-32);
        }

        .btn {
            padding: var(--space-12) var(--space-24);
            border: none;
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--duration-normal);
            font-family: var(--font-family-base);
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-8);
            min-width: fit-content;
        }

        .btn-primary {
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-primary:active {
            background: var(--color-primary-active);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--color-secondary);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: var(--color-secondary-hover);
        }

        .btn-danger {
            background: var(--color-error);
            color: white;
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        .btn-group {
            display: flex;
            gap: var(--space-12);
            flex-wrap: wrap;
            margin-top: var(--space-20);
        }

        .table-container {
            background: white;
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-card-border);
            overflow: hidden;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size-sm);
        }

        thead {
            background: var(--color-gray-200);
            border-bottom: 2px solid var(--color-border);
        }

        th {
            padding: var(--space-12);
            text-align: left;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
        }

        td {
            padding: var(--space-12);
            border-bottom: 1px solid var(--color-card-border);
        }

        tbody tr:hover {
            background: var(--color-gray-200);
        }

        .action-btns {
            display: flex;
            gap: var(--space-8);
        }

        .btn-sm {
            padding: var(--space-4) var(--space-8);
            font-size: var(--font-size-xs);
        }

        .empty-state {
            text-align: center;
            padding: var(--space-32);
            color: var(--color-text-secondary);
        }

        .empty-state-icon {
            font-size: 2.5rem;
            margin-bottom: var(--space-12);
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-16);
            margin-bottom: var(--space-20);
        }

        .summary-card {
            background: white;
            padding: var(--space-20);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-card-border);
            text-align: center;
        }

        .summary-card-value {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            margin: 0 0 var(--space-8) 0;
        }

        .summary-card-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin: 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            max-width: 400px;
            width: 90%;
        }

        .edit-modal-content {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            max-width: 500px;
            width: 90%;
        }

        .modal-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            margin: 0 0 var(--space-16) 0;
        }

        .modal-buttons {
            display: flex;
            gap: var(--space-12);
            margin-top: var(--space-20);
        }

        .modal-form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-16);
            margin-bottom: var(--space-20);
        }

        .modal-form-group {
            display: flex;
            flex-direction: column;
        }

        .modal-form-label {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            margin-bottom: var(--space-6);
            color: var(--color-text);
        }

        .modal-form-control {
            padding: var(--space-8) var(--space-12);
            font-size: var(--font-size-base);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            background: var(--color-surface);
            color: var(--color-text);
            font-family: var(--font-family-base);
            transition: all var(--duration-fast);
        }

        .modal-form-control:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-focus-ring);
        }

        select.modal-form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right var(--space-12) center;
            background-size: 16px;
            padding-right: var(--space-32);
        }

        .admin-section {
            background: var(--color-secondary);
            padding: var(--space-20);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-20);
        }

        .settings-grid {
            display: grid;
            gap: var(--space-16);
        }

        .settings-item {
            background: white;
            padding: var(--space-16);
            border-radius: var(--radius-base);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--color-card-border);
        }

        .settings-item-title {
            font-weight: var(--font-weight-medium);
        }

        .settings-item-desc {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin-top: var(--space-4);
        }

        .badge {
            display: inline-block;
            padding: var(--space-4) var(--space-8);
            background: var(--color-secondary);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        .badge-admin {
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
        }

        .bands-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: var(--space-12);
            margin: var(--space-16) 0;
        }

        .band-block {
            background: white;
            border: 2px solid var(--color-primary);
            border-radius: var(--radius-md);
            padding: var(--space-12);
            text-align: center;
            transition: all var(--duration-normal);
            position: relative;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .band-block:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
            border-color: var(--color-primary-hover);
        }

        .band-input {
            padding: var(--space-8) var(--space-12);
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            border: none;
            border-bottom: 2px solid var(--color-primary);
            background: transparent;
            text-align: center;
            width: 100%;
            font-family: var(--font-family-base);
            transition: all var(--duration-fast);
        }

        .band-input:focus {
            outline: none;
            border-bottom-color: var(--color-primary-hover);
        }

        .band-block-label {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            margin: var(--space-8) 0 0 0;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--color-success);
            color: white;
            padding: var(--space-16) var(--space-24);
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
            max-width: 400px;
            font-weight: var(--font-weight-semibold);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast.hide {
            animation: slideOut 0.3s ease-out;
        }

        .filter-section {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-20);
            margin-bottom: var(--space-20);
            border: 1px solid var(--color-card-border);
        }

        .filter-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            margin: 0 0 var(--space-16) 0;
            color: var(--color-primary);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-12);
            margin-bottom: var(--space-16);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            margin-bottom: var(--space-6);
            color: var(--color-text);
        }

        .filter-control {
            padding: var(--space-8) var(--space-12);
            font-size: var(--font-size-sm);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            background: var(--color-surface);
            color: var(--color-text);
            font-family: var(--font-family-base);
            transition: all var(--duration-fast);
        }

        .filter-control:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-focus-ring);
        }

        .filter-buttons {
            display: flex;
            gap: var(--space-12);
        }

        .results-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-16);
            background: var(--color-secondary);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-16);
        }

        .results-count {
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
        }

        .results-summary {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .user-selection {
                grid-template-columns: 1fr;
            }
            
            .action-btns {
                flex-direction: column;
            }

            .bands-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .filter-buttons {
                flex-direction: column;
            }

            .results-info {
                flex-direction: column;
                gap: var(--space-12);
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="userSelectionScreen" class="container" style="padding-top: var(--space-32);">
            <h1 style="text-align: center; font-size: var(--font-size-3xl); margin-bottom: var(--space-32);">Select User Profile</h1>
            <div class="user-selection" id="userSelectionGrid"></div>
        </div>

        <div id="mainApp" style="display: none;">
            <div class="header">
                <h1 class="header-title">Band Entry Management</h1>
                <div class="header-right">
                    <div class="user-indicator">Logged in as: <strong id="currentUserDisplay"></strong></div>
                    <button class="user-switch" onclick="switchUser()">Switch User</button>
                </div>
            </div>

            <div style="border-bottom: 1px solid var(--color-border); background: white;">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('entry')">üìù Entry Form</button>
                    <button class="tab" onclick="switchTab('viewData')">üìä View Data</button>
                    <button class="tab" onclick="switchTab('settings')" id="adminTab" style="display: none;">‚öôÔ∏è Settings</button>
                </div>
            </div>

            <div class="container">
                <div id="entryPage" class="page active">
                    <div class="form-section">
                        <h2 class="form-title">Record New Entry</h2>
                        
                        <div class="form-group" style="margin-bottom: var(--space-20);">
                            <label class="form-label required">Current Band No.</label>
                            <input type="number" id="currentBandNo" class="form-control" placeholder="e.g., 101">
                        </div>

                        <form id="entryForm">
                            <input type="hidden" id="pendingBandNumbers" value="[]">
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label required">Name</label>
                                    <input type="text" id="name" class="form-control" placeholder="Enter name" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label required">Zone</label>
                                    <select id="zone" class="form-control" required onchange="updateCommunities()">
                                        <option value="">Select a zone</option>
                                        <option value="1">Zone 1</option>
                                        <option value="2">Zone 2</option>
                                        <option value="3A">Zone 3 A</option>
                                        <option value="3B">Zone 3 B</option>
                                        <option value="4A">Zone 4 A</option>
                                        <option value="4B">Zone 4 B</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label required">Community</label>
                                    <select id="community" class="form-control" required>
                                        <option value="">Select community</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label required">Number of Bands</label>
                                    <input type="number" id="numBands" class="form-control" placeholder="e.g., 4" min="1" required onchange="calculateCost()">
                                </div>
                            </div>

                            <div>
                                <p class="bands-display-title" style="margin-bottom: var(--space-12); font-weight: var(--font-weight-semibold);">Bands to be allocated (click to edit)</p>
                                <div class="bands-grid" id="bandsGrid"></div>
                                <p id="bandRangeText" style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin: var(--space-12) 0 0 0; text-align: center;"></p>
                            </div>

                            <div class="payment-section" style="background: var(--color-secondary); padding: var(--space-16); border-radius: var(--radius-base); margin: var(--space-20) 0;">
                                <p class="payment-title" style="font-size: var(--font-size-base); font-weight: var(--font-weight-semibold); margin: 0 0 var(--space-12) 0; display: flex; align-items: center; gap: var(--space-8);">üí∞ Payment Details</p>
                                <p class="payment-amount" style="font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); color: var(--color-primary); margin: 0;">‚Çπ<span id="totalAmount">0</span></p>
                                <p class="payment-breakdown" id="paymentBreakdown" style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--space-8);">0 bands √ó ‚Çπ50/band = ‚Çπ0</p>
                            </div>

                            <div class="btn-group">
                                <button type="submit" class="btn btn-primary">Submit Entry</button>
                                <button type="reset" class="btn btn-secondary" id="clearFormBtn">Clear Form</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="viewDataPage" class="page">
                    <div class="summary-cards">
                        <div class="summary-card">
                            <p class="summary-card-value" id="totalEntriesDisplay">0</p>
                            <p class="summary-card-label">Total Entries</p>
                        </div>
                        <div class="summary-card">
                            <p class="summary-card-value" id="totalBandsSoldDisplay">0</p>
                            <p class="summary-card-label">Total Bands Sold</p>
                        </div>
                        <div class="summary-card">
                            <p class="summary-card-value">‚Çπ<span id="totalRevenueDisplay">0</span></p>
                            <p class="summary-card-label">Total Revenue</p>
                        </div>
                    </div>

                    <div class="filter-section">
                        <h3 class="filter-title">üîç Filter & Search</h3>
                        <div class="filter-grid">
                            <div class="filter-group">
                                <label class="filter-label">Search by Name</label>
                                <input type="text" id="searchName" class="filter-control" placeholder="Enter name..." onkeyup="applyFilters()">
                            </div>

                            <div class="filter-group">
                                <label class="filter-label">Filter by Date</label>
                                <input type="date" id="filterDate" class="filter-control" onchange="applyFilters()">
                            </div>

                            <div class="filter-group">
                                <label class="filter-label">Start Time</label>
                                <input type="time" id="filterTimeStart" class="filter-control" onchange="applyFilters()">
                            </div>

                            <div class="filter-group">
                                <label class="filter-label">End Time</label>
                                <input type="time" id="filterTimeEnd" class="filter-control" onchange="applyFilters()">
                            </div>

                            <div class="filter-group">
                                <label class="filter-label">Sort By</label>
                                <select id="sortBy" class="filter-control" onchange="applyFilters()">
                                    <option value="band-asc">Band # (Low to High)</option>
                                    <option value="band-desc">Band # (High to Low)</option>
                                    <option value="date-newest">Date (Newest First)</option>
                                    <option value="date-oldest">Date (Oldest First)</option>
                                    <option value="name-asc">Name (A to Z)</option>
                                    <option value="name-desc">Name (Z to A)</option>
                                    <option value="amount-high">Amount (High to Low)</option>
                                    <option value="amount-low">Amount (Low to High)</option>
                                </select>
                            </div>
                        </div>
                        <div class="filter-buttons">
                            <button class="btn btn-primary" onclick="applyFilters()">üîÑ Apply Filters</button>
                            <button class="btn btn-secondary" onclick="resetFilters()">‚úï Clear Filters</button>
                        </div>
                    </div>

                    <div class="results-info">
                        <div>
                            <div class="results-count">Showing <span id="filteredCount">0</span> of <span id="totalCount">0</span> entries</div>
                            <div class="results-summary" id="filterSummary"></div>
                        </div>
                    </div>

                    <div style="margin-bottom: var(--space-20);">
                        <button class="btn btn-primary" id="downloadXLSXBtn" onclick="downloadData(isAdmin ? 'all' : 'user')">üì• Download My Data (XLSX)</button>
                        <button class="btn btn-secondary" id="downloadCSVBtn" onclick="downloadData(isAdmin ? 'all' : 'user', 'csv')" style="margin-left: var(--space-12);">üì• Download CSV</button>
                    </div>

                    <div class="table-container">
                        <table id="dataTable">
                            <thead>
                                <tr>
                                    <th>Band No.</th>
                                    <th>Name</th>
                                    <th>Zone</th>
                                    <th>Community</th>
                                    <th>Amount (‚Çπ)</th>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th id="userHeader" style="display: none;">User</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody">
                                <tr class="empty-state">
                                    <td colspan="9">
                                        <div class="empty-state-icon">üìã</div>
                                        <p>No data yet. Add entries from the Entry Form tab to see them here.</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="settingsPage" class="page">
                    <div class="form-section">
                        <h2 class="form-title">Admin Settings</h2>
                        
                        <div class="admin-section">
                            <h3 style="margin-top: 0;">User Management</h3>
                            <div class="settings-grid">
                                <div class="settings-item">
                                    <div>
                                        <div class="settings-item-title">Create New User</div>
                                        <div class="settings-item-desc">Add a new user profile to the system</div>
                                    </div>
                                    <button class="btn btn-primary" onclick="showCreateUserModal()">+ Add User</button>
                                </div>

                                <div class="settings-item">
                                    <div>
                                        <div class="settings-item-title">Manage Users</div>
                                        <div class="settings-item-desc">View and delete existing users</div>
                                    </div>
                                    <button class="btn btn-secondary" onclick="showManageUsersModal()">Manage</button>
                                </div>
                            </div>
                        </div>

                        <div class="admin-section" style="margin-top: var(--space-20);">
                            <h3 style="margin-top: 0;">Export Data</h3>
                            <div class="settings-grid">
                                <div class="settings-item">
                                    <div>
                                        <div class="settings-item-title">Download All Data</div>
                                        <div class="settings-item-desc">Export all users' data with user names</div>
                                    </div>
                                    <button class="btn btn-primary" onclick="downloadAllData('xlsx')">üì• Export XLSX</button>
                                </div>

                                <div class="settings-item">
                                    <div>
                                        <div class="settings-item-title">Download CSV</div>
                                        <div class="settings-item-desc">Export all data as CSV format</div>
                                    </div>
                                    <button class="btn btn-primary" onclick="downloadAllData('csv')">üì• Export CSV</button>
                                </div>
                            </div>
                        </div>

                        <div class="admin-section" style="margin-top: var(--space-20);">
                            <h3 style="margin-top: 0;">Database</h3>
                            <div class="settings-grid">
                                <div class="settings-item">
                                    <div>
                                        <div class="settings-item-title">Clear All Data</div>
                                        <div class="settings-item-desc">Permanently delete all entries and users (cannot be undone)</div>
                                    </div>
                                    <button class="btn btn-danger" onclick="clearAllData()">‚ö†Ô∏è Clear All</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Create New User</h2>
            <div class="modal-form-grid">
                <div class="modal-form-group">
                    <label class="modal-form-label">Username</label>
                    <input type="text" id="newUsername" class="modal-form-control" placeholder="Enter username">
                </div>
                <div class="modal-form-group">
                    <label class="modal-form-label">Password</label>
                    <input type="password" id="newPassword" class="modal-form-control" placeholder="Enter password">
                </div>
                <div class="modal-form-group">
                    <label class="modal-form-label">Assign Category/Role</label>
                    <select id="newUserRole" class="modal-form-control">
                        <option value="Zonal Coordinator">Zonal Coordinator</option>
                        <option value="Desk">Desk</option>
                        <option value="Church Office">Church Office</option>
                    </select>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="createUser()">Create</button>
                <button class="btn btn-secondary" onclick="closeModal('createUserModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Edit User Details</h2>
            <div class="modal-form-grid">
                <input type="hidden" id="editUserId">
                <div class="modal-form-group">
                    <label class="modal-form-label">Username</label>
                    <input type="text" id="editUsernameField" class="modal-form-control" placeholder="Update username">
                </div>
                <div class="modal-form-group">
                    <label class="modal-form-label">Password</label>
                    <input type="text" id="editPasswordField" class="modal-form-control" placeholder="Update password">
                </div>
                <div class="modal-form-group">
                    <label class="modal-form-label">Category / Role</label>
                    <select id="editUserRole" class="modal-form-control">
                        <option value="Zonal Coordinator">Zonal Coordinator</option>
                        <option value="Desk">Desk</option>
                        <option value="Church Office">Church Office</option>
                    </select>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="saveEditedUser()">Update User</button>
                <button class="btn btn-secondary" onclick="closeModal('editUserModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="manageUsersModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Manage Users</h2>
            <div id="usersList" style="max-height: 300px; overflow-y: auto; margin-bottom: var(--space-16);"></div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal('manageUsersModal')">Close</button>
            </div>
        </div>
    </div>

    <div id="adminPasswordModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Admin Access Required</h2>
            <p style="margin-bottom: var(--space-16); color: var(--color-text-secondary);">Enter admin password to continue.</p>
            <div class="modal-form-group">
                <label class="modal-form-label">Password</label>
                <input type="password" id="adminPassword" class="modal-form-control" placeholder="Enter password" autocomplete="off">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="verifyAdminPassword()">Verify</button>
                <button class="btn btn-secondary" onclick="closeAdminModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="userPasswordModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Enter Password</h2>
            <p style="margin-bottom: var(--space-16); color: var(--color-text-secondary);" id="userPasswordPrompt"></p>
            <div class="modal-form-group">
                <label class="modal-form-label">Password</label>
                <input type="password" id="userPassword" class="modal-form-control" placeholder="Enter password" autocomplete="off">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="verifyUserPassword()">Login</button>
                <button class="btn btn-secondary" onclick="closeUserPasswordModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="editEntryModal" class="modal">
        <div class="edit-modal-content">
            <h2 class="modal-title">Edit Entry</h2>
            
            <div class="modal-form-grid">
                <div class="modal-form-group">
                    <label class="modal-form-label">Band No.</label>
                    <input type="number" id="editBandNo" class="modal-form-control" placeholder="e.g., 101">
                </div>

                <div class="modal-form-group">
                    <label class="modal-form-label">Name</label>
                    <input type="text" id="editName" class="modal-form-control" placeholder="Enter name">
                </div>

                <div class="modal-form-group">
                    <label class="modal-form-label">Zone</label>
                    <select id="editZone" class="modal-form-control" onchange="updateEditCommunities()">
                        <option value="">Select a zone</option>
                        <option value="1">Zone 1</option>
                        <option value="2">Zone 2</option>
                        <option value="3A">Zone 3 A</option>
                        <option value="3B">Zone 3 B</option>
                        <option value="4A">Zone 4 A</option>
                        <option value="4B">Zone 4 B</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="modal-form-group">
                    <label class="modal-form-label">Community</label>
                    <select id="editCommunity" class="modal-form-control">
                        <option value="">Select community</option>
                    </select>
                </div>

                <div class="modal-form-group">
                    <label class="modal-form-label">Amount (‚Çπ)</label>
                    <input type="number" id="editAmount" class="modal-form-control" placeholder="e.g., 50">
                </div>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="saveEditedEntry()">Save Changes</button>
                <button class="btn btn-secondary" onclick="closeModal('editEntryModal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        const communities = {
            '1': ['Morning Star', 'St. Andrew', 'Holy Trinity', 'St. Ann & St. Michael', 'Divya Jyothi', 'Unknown'],
            '2': ['Our Lady of Velankani', 'St. Anne', 'St. John', 'Holy Cross', 'St. Sebastian', 'Immaculate Conception', 'Unknown'],
            '3A': ['Divine Angel', 'Ave Maria', 'Unknown'],
            '3B': ['Our Lady of Rosary', 'Our Lady of Nazareth', 'Mother Theresa', 'St. Thomas', 'St. Francis Xavier', 'St. Anthony', 'Holy Cross', 'Unknown'],
            '4A': ['Gonsalo Gracia', 'Servers', 'St. Luke', 'St. Theresa', 'Don Bosco', 'Unknown'],
            '4B': ['St. Joseph', 'St. Anthony', 'St. Peter', 'Dominic Savio', 'Unknown'],
            'Other': ['Other', 'Unknown']
        };

        const ADMIN_PASSWORD = 'admin123';
        const ADMIN_USERNAME = 'admin';

        let currentUser = null;
        let isAdmin = false;
        let selectedCategory = null; // New state for role/category selection
        let users = {};
        let allEntries = [];
        let filteredEntries = [];
        let currentEditingEntryId = null;
        let pendingUserLogin = { username: null, password: null };

        function showToast(message, duration = 3000) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('hide');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function formatDateIST(date) {
            const d = new Date(date);
            return {
                date: d.toLocaleDateString('en-IN', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                time: d.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false })
            };
        }

        function saveLastBandNumber(bandNo) {
            localStorage.setItem(`lastBandNo_${currentUser}`, bandNo.toString());
        }

        function loadLastBandNumber() {
            if (!currentUser) return '';
            const saved = localStorage.getItem(`lastBandNo_${currentUser}`);
            return saved || '';
        }

        async function loadUsers() {
            try {
                const res = await fetch(`${API_BASE}/manage-users`);
                const result = await res.json();
                if (!res.ok || !result.success) throw new Error(result.error);
                users = {};
                result.data.forEach(u => {
                    users[u.username] = { isAdmin: u.isAdmin, password: u.password, role: u.role || 'Desk', _id: u._id }; // Default legacy to 'Desk'
                });
                if (!users['admin']) {
                    users['admin'] = { isAdmin: true, password: ADMIN_PASSWORD };
                }
            } catch (err) {
                console.error('Error loading users:', err);
            }
        }

        async function initApp() {
            await loadUsers();
            const userSelectionScreen = document.getElementById('userSelectionScreen');
            const mainApp = document.getElementById('mainApp');
            if (!currentUser) {
                userSelectionScreen.style.display = 'block';
                mainApp.style.display = 'none';
                displayCategorySelection(); // First screen: Select Category
            } else {
                userSelectionScreen.style.display = 'none';
                mainApp.style.display = 'block';
                document.getElementById('currentBandNo').value = loadLastBandNumber();
                updateUI();
            }
        }

        // New function to display the 3 main categories
        function displayCategorySelection() {
            const grid = document.getElementById('userSelectionGrid');
            grid.innerHTML = '';
            document.querySelector('#userSelectionScreen h1').textContent = 'Select Category';
            const categories = [
                { name: 'Zonal Coordinators', icon: 'üìç', id: 'Zonal Coordinator' },
                { name: 'Desk', icon: 'üñ•Ô∏è', id: 'Desk' },
                { name: 'Church Office', icon: '‚õ™', id: 'Church Office' }
            ];
            categories.forEach(cat => {
                const card = document.createElement('div');
                card.className = 'user-card';
                card.onclick = () => {
                    selectedCategory = cat.id;
                    displayUserSelection();
                };
                card.innerHTML = `
                    <div class="user-card-icon">${cat.icon}</div>
                    <p class="user-card-name">${cat.name}</p>
                `;
                grid.appendChild(card);
            });
            // Admin button at bottom
            const adminDiv = document.createElement('div');
            adminDiv.style.textAlign = 'center';
            adminDiv.style.gridColumn = '1 / -1';
            adminDiv.innerHTML = `<button class="btn btn-secondary" onclick="selectUser('admin')">üë®‚Äçüíº Admin Login</button>`;
            grid.appendChild(adminDiv);
        }

        function displayUserSelection() {
            const grid = document.getElementById('userSelectionGrid');
            grid.innerHTML = '';
            document.querySelector('#userSelectionScreen h1').textContent = `Select Profile: ${selectedCategory}`;
            
            const backBtn = document.createElement('div');
            backBtn.style.gridColumn = '1 / -1';
            backBtn.innerHTML = `<button class="btn btn-sm btn-secondary" onclick="selectedCategory=null; displayCategorySelection();">‚Üê Back to Categories</button>`;
            grid.appendChild(backBtn);

            Object.keys(users).forEach(username => {
                const user = users[username];
                if (user.role === selectedCategory && !user.isAdmin) { // Filter by selected role
                    const card = document.createElement('div');
                    card.className = 'user-card';
                    card.onclick = () => selectUser(username);
                    card.innerHTML = `
                        <div class="user-card-icon">üë§</div>
                        <p class="user-card-name">${username}</p>
                    `;
                    grid.appendChild(card);
                }
            });
        }

        function selectUser(username) {
            if (username === ADMIN_USERNAME) {
                document.getElementById('adminPasswordModal').classList.add('active');
                document.getElementById('adminPassword').focus();
            } else {
                pendingUserLogin.username = username;
                document.getElementById('userPasswordPrompt').textContent = `Enter password for "${username}"`;
                document.getElementById('userPassword').value = '';
                document.getElementById('userPasswordModal').classList.add('active');
                document.getElementById('userPassword').focus();
            }
        }

        function verifyAdminPassword() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                currentUser = ADMIN_USERNAME;
                isAdmin = true;
                document.getElementById('adminPassword').value = '';
                closeAdminModal();
                initApp();
                loadEntries();
            } else {
                alert('Incorrect password.');
            }
        }

        function verifyUserPassword() {
            const password = document.getElementById('userPassword').value;
            const username = pendingUserLogin.username;
            if (users[username] && users[username].password === password) {
                currentUser = username;
                isAdmin = false;
                document.getElementById('userPassword').value = '';
                closeUserPasswordModal();
                initApp();
                loadEntries();
            } else {
                alert('Incorrect password.');
            }
        }

        function closeAdminModal() {
            document.getElementById('adminPasswordModal').classList.remove('active');
        }

        function closeUserPasswordModal() {
            document.getElementById('userPasswordModal').classList.remove('active');
        }

        function switchUser() {
            currentUser = null;
            isAdmin = false;
            selectedCategory = null;
            initApp();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(tabName + 'Page').classList.add('active');
            if (tabName === 'viewData') loadEntries();
        }

        function updateUI() {
            document.getElementById('currentUserDisplay').textContent = currentUser;
            if (isAdmin) {
                document.getElementById('adminTab').style.display = 'block';
                document.getElementById('entryForm').style.display = 'none';
                const eTab = document.querySelector('[onclick="switchTab(\'entry\')"]');
                if (eTab) eTab.style.display = 'none';
            } else {
                document.getElementById('adminTab').style.display = 'none';
                document.getElementById('entryForm').style.display = 'block';
                const eTab = document.querySelector('[onclick="switchTab(\'entry\')"]');
                if (eTab) eTab.style.display = 'inline-block';
            }
        }

        function updateCommunities() {
            const zone = document.getElementById('zone').value;
            const cSelect = document.getElementById('community');
            cSelect.innerHTML = '<option value="">Select community</option>';
            if (zone && communities[zone]) {
                communities[zone].forEach(c => {
                    const o = document.createElement('option');
                    o.value = `Zone ${zone} - ${c}`;
                    o.textContent = `Zone ${zone} - ${c}`;
                    cSelect.appendChild(o);
                });
            }
        }

        function updateEditCommunities() {
            const zone = document.getElementById('editZone').value;
            const cSelect = document.getElementById('editCommunity');
            cSelect.innerHTML = '<option value="">Select community</option>';
            if (zone && communities[zone]) {
                communities[zone].forEach(c => {
                    const o = document.createElement('option');
                    o.value = `Zone ${zone} - ${c}`;
                    o.textContent = `Zone ${zone} - ${c}`;
                    cSelect.appendChild(o);
                });
            }
        }

        function calculateCost() {
            const numBands = parseInt(document.getElementById('numBands').value) || 0;
            const totalCost = numBands * 50;
            document.getElementById('totalAmount').textContent = totalCost;
            document.getElementById('paymentBreakdown').textContent = `${numBands} bands √ó ‚Çπ50/band = ‚Çπ${totalCost}`;
            displayBandBlocks(numBands);
            document.getElementById('bandRangeText').textContent = numBands ? `${numBands} band${numBands > 1 ? 's' : ''} allocated` : '';
        }

        function displayBandBlocks(count) {
            const currentBandNo = parseInt(document.getElementById('currentBandNo').value) || 0;
            const bandsGrid = document.getElementById('bandsGrid');
            bandsGrid.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const bandNum = currentBandNo + i;
                const block = document.createElement('div');
                block.className = 'band-block';
                block.innerHTML = `
                    <input type="number" class="band-input" value="${bandNum}" data-index="${i}" onchange="updateBandNumber(this)">
                    <p class="band-block-label">Band #</p>
                `;
                bandsGrid.appendChild(block);
            }
            updatePendingBands();
        }

        function updateBandNumber(input) {
            const newValue = parseInt(input.value);
            const allInputs = document.querySelectorAll('.band-input');
            const values = Array.from(allInputs).map(i => parseInt(i.value));
            if (values.filter(v => v === newValue).length > 1) {
                alert('Duplicate band number in this group.');
                return;
            }
            updatePendingBands();
        }

        function updatePendingBands() {
            const bandInputs = document.querySelectorAll('.band-input');
            const bandNumbers = Array.from(bandInputs).map(b => parseInt(b.value));
            document.getElementById('pendingBandNumbers').value = JSON.stringify(bandNumbers);
        }

        async function addEntry(event) {
            event.preventDefault();
            const submitBtn = event.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            const name = document.getElementById('name').value.trim();
            const zone = document.getElementById('zone').value;
            const community = document.getElementById('community').value;
            const numBands = parseInt(document.getElementById('numBands').value);
            let bandNumbers = JSON.parse(document.getElementById('pendingBandNumbers').value || '[]');
            try {
                const res = await fetch(`${API_BASE}/save-entry`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser, bands: bandNumbers, name, zone, community, amountPerBand: 50 })
                });
                const result = await res.json();
                if (res.status === 409) {
                    showToast(`Duplicate band found: ${result.duplicateBands.map(d => d.bandNo).join(', ')}`, 5000);
                    return;
                }
                if (!res.ok || !result.success) throw new Error(result.error);
                saveLastBandNumber(Math.max(...bandNumbers) + 1);
                document.getElementById('currentBandNo').value = Math.max(...bandNumbers) + 1;
                document.getElementById('entryForm').reset();
                document.getElementById('bandsGrid').innerHTML = '';
                showToast(`Added ${bandNumbers.length} band(s)`);
            } catch (err) {
                showToast('Error: ' + err.message);
            } finally {
                submitBtn.disabled = false;
            }
        }

        async function loadEntries() {
            const uParam = isAdmin ? 'all' : currentUser;
            try {
                const res = await fetch(`${API_BASE}/get-entries?userId=${encodeURIComponent(uParam)}`);
                const result = await res.json();
                allEntries = result.data || [];
                applyFilters();
            } catch (err) {
                showToast('Error loading entries.');
            }
        }

        function applyFilters() {
            const sName = document.getElementById('searchName').value.toLowerCase();
            const fDate = document.getElementById('filterDate').value;
            const fStart = document.getElementById('filterTimeStart').value;
            const fEnd = document.getElementById('filterTimeEnd').value;
            const sBy = document.getElementById('sortBy').value;

            filteredEntries = allEntries.filter(e => {
                if (sName && !e.name.toLowerCase().includes(sName)) return false;
                if (fDate && new Date(e.createdAt).toLocaleDateString('en-CA') !== fDate) return false;
                if (fStart || fEnd) {
                    const eTime = new Date(e.createdAt).toLocaleTimeString('en-GB', { hour12: false }).slice(0, 5);
                    if (fStart && eTime < fStart) return false;
                    if (fEnd && eTime > fEnd) return false;
                }
                return true;
            });

            if (sBy === 'band-asc') filteredEntries.sort((a,b) => a.bandNo - b.bandNo);
            if (sBy === 'band-desc') filteredEntries.sort((a,b) => b.bandNo - a.bandNo);
            if (sBy === 'date-newest') filteredEntries.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            if (sBy === 'name-asc') filteredEntries.sort((a,b) => a.name.localeCompare(b.name));

            updateDataTable(filteredEntries);
        }

        function updateDataTable(entries) {
            const tbody = document.getElementById('dataTableBody');
            document.getElementById('userHeader').style.display = isAdmin ? 'table-cell' : 'none';
            if (entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center">No data found.</td></tr>';
                return;
            }
            tbody.innerHTML = entries.map(e => {
                const f = formatDateIST(e.createdAt);
                return `<tr>
                    <td>#${e.bandNo}</td><td>${e.name}</td><td>${e.zone}</td><td>${e.community}</td><td>‚Çπ${e.amount}</td>
                    <td>${f.date}</td><td>${f.time}</td>${isAdmin ? `<td>${e.userId}</td>` : ''}
                    <td><div class="action-btns">
                        <button class="btn btn-sm btn-secondary" onclick="editEntry('${e._id}','${e.bandNo}','${e.name}','${e.zone}','${e.community}','${e.amount}')">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteEntryMongo('${e._id}')">Delete</button>
                    </div></td>
                </tr>`;
            }).join('');
            updateSummary(allEntries);
        }

        function updateSummary(entries) {
            document.getElementById('totalEntriesDisplay').textContent = entries.length;
            document.getElementById('totalBandsSoldDisplay').textContent = entries.length;
            document.getElementById('totalRevenueDisplay').textContent = entries.reduce((s, e) => s + (e.amount || 0), 0);
        }

        function editEntry(id, bandNo, name, zone, community, amount) {
            currentEditingEntryId = id;
            document.getElementById('editBandNo').value = bandNo;
            document.getElementById('editName').value = name;
            document.getElementById('editZone').value = zone.split(' - ')[0];
            document.getElementById('editAmount').value = amount;
            updateEditCommunities();
            setTimeout(() => { document.getElementById('editCommunity').value = community; }, 100);
            document.getElementById('editEntryModal').classList.add('active');
        }

        async function saveEditedEntry() {
            const body = { 
                id: currentEditingEntryId, 
                newBandNo: parseInt(document.getElementById('editBandNo').value),
                name: document.getElementById('editName').value.trim(),
                zone: document.getElementById('editZone').value,
                community: document.getElementById('editCommunity').value,
                amount: parseInt(document.getElementById('editAmount').value)
            };
            try {
                const res = await fetch(`${API_BASE}/update-entry`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                if (res.status === 409) return alert('Band number already exists.');
                closeModal('editEntryModal');
                loadEntries();
            } catch (err) { showToast('Update failed.'); }
        }

        async function deleteEntryMongo(id) {
            if (!confirm('Delete this entry?')) return;
            try {
                await fetch(`${API_BASE}/delete-entry?id=${encodeURIComponent(id)}`, { method: 'DELETE' });
                loadEntries();
            } catch (err) { showToast('Delete failed.'); }
        }

        async function createUser() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value.trim();
            const role = document.getElementById('newUserRole').value; // Get role from select
            if (!username || !password) return alert('Username and password required.');
            try {
                const res = await fetch(`${API_BASE}/manage-users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, role }), // Include role in creation
                });
                const result = await res.json();
                if (!res.ok) throw new Error(result.error);
                closeModal('createUserModal');
                showToast(`User created as ${role}`);
                await loadUsers();
            } catch (err) { showToast('Creation failed: ' + err.message); }
        }

        // --- User Edit logic ---
        function openEditUserModal(username) {
            const user = users[username];
            document.getElementById('editUserId').value = user._id;
            document.getElementById('editUsernameField').value = username;
            document.getElementById('editPasswordField').value = user.password;
            document.getElementById('editUserRole').value = user.role || 'Desk';
            document.getElementById('editUserModal').classList.add('active');
        }

        async function saveEditedUser() {
            const body = {
                id: document.getElementById('editUserId').value,
                username: document.getElementById('editUsernameField').value.trim(),
                password: document.getElementById('editPasswordField').value.trim(),
                role: document.getElementById('editUserRole').value
            };
            try {
                const res = await fetch(`${API_BASE}/manage-users`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const result = await res.json();
                if (result.success) {
                    showToast('User profile updated.');
                    closeModal('editUserModal');
                    await loadUsers();
                    showManageUsersModal();
                }
            } catch (err) { alert('Update failed.'); }
        }

        function showManageUsersModal() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';
            Object.keys(users).forEach(username => {
                const user = users[username];
                if (!user.isAdmin) {
                    const item = document.createElement('div');
                    item.className = 'settings-item';
                    item.innerHTML = `
                        <div style="flex:1">
                            <div class="settings-item-title">${username} <span class="badge">${user.role || 'Desk'}</span></div>
                            <div class="settings-item-desc">Pass: ${user.password}</div>
                        </div>
                        <div class="action-btns">
                            <button class="btn btn-sm btn-secondary" onclick="openEditUserModal('${username}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser('${username}')">Delete</button>
                        </div>`;
                    usersList.appendChild(item);
                }
            });
            document.getElementById('manageUsersModal').classList.add('active');
        }

        async function deleteUser(username) {
            if (!confirm(`Delete user '${username}'?`)) return;
            await fetch(`${API_BASE}/manage-users?username=${encodeURIComponent(username)}`, { method: 'DELETE' });
            await loadUsers();
            showManageUsersModal();
        }

        function showCreateUserModal() {
            document.getElementById('createUserModal').classList.add('active');
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
        }

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        window.onload = () => initApp();
        document.getElementById('entryForm').addEventListener('submit', addEntry);
    </script>
</body>
</html>