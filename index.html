<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Band Entry Management System</title>
    <style>
        :root {
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);

            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-red-400-rgb: 255, 84, 89;

            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            --color-error: var(--color-red-500);
            --color-success: var(--color-teal-500);
            --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);

            --font-family-base: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-md: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 550;
            --font-weight-bold: 600;
            --line-height-tight: 1.2;
            --line-height-normal: 1.5;
            --letter-spacing-tight: -0.01em;

            --space-2: 2px;
            --space-4: 4px;
            --space-6: 6px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;

            --radius-sm: 6px;
            --radius-base: 8px;
            --radius-md: 10px;
            --radius-lg: 12px;
            --radius-full: 9999px;

            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04);
            --duration-fast: 150ms;
            --duration-normal: 250ms;
            --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family-base);
            background-color: var(--color-background);
            color: var(--color-text);
        }

        body {
            min-height: 100vh;
        }

        .header {
            background: white;
            border-bottom: 1px solid var(--color-border);
            padding: var(--space-16);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            margin: 0;
        }

        .header-right {
            display: flex;
            gap: var(--space-12);
            align-items: center;
        }

        .user-switch {
            background: var(--color-secondary);
            border: none;
            padding: var(--space-8) var(--space-16);
            border-radius: var(--radius-base);
            cursor: pointer;
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            transition: all var(--duration-fast);
        }

        .user-switch:hover {
            background: var(--color-secondary-hover);
        }

        .user-indicator {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-16);
        }

        .user-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-16);
            padding: var(--space-32);
        }

        .user-card {
            background: white;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-20);
            cursor: pointer;
            transition: all var(--duration-normal);
            text-align: center;
        }

        .user-card:hover {
            border-color: var(--color-primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .user-card-icon {
            font-size: 2.5rem;
            margin-bottom: var(--space-12);
        }

        .user-card-name {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            margin: 0;
        }

        .tabs {
            display: flex;
            gap: var(--space-2);
            border-bottom: 2px solid var(--color-border);
            background: white;
            padding: 0 var(--space-16);
        }

        .tab {
            background: none;
            border: none;
            padding: var(--space-12) var(--space-16);
            cursor: pointer;
            font-size: var(--font-size-base);
            color: var(--color-text-secondary);
            border-bottom: 3px solid transparent;
            transition: all var(--duration-fast);
            margin-bottom: -2px;
        }

        .tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .page {
            display: none;
            animation: fadeIn var(--duration-normal);
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .form-section {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            margin-bottom: var(--space-20);
            border: 1px solid var(--color-card-border);
        }

        .form-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            margin: 0 0 var(--space-20) 0;
            color: var(--color-primary);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-16);
            margin-bottom: var(--space-20);
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            margin-bottom: var(--space-6);
            color: var(--color-text);
        }

        .form-label.required::after {
            content: ' *';
            color: var(--color-error);
        }

        .form-control {
            padding: var(--space-8) var(--space-12);
            font-size: var(--font-size-base);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            background: var(--color-surface);
            color: var(--color-text);
            font-family: var(--font-family-base);
            transition: all var(--duration-fast);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-focus-ring);
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right var(--space-12) center;
            background-size: 16px;
            padding-right: var(--space-32);
        }

        .btn {
            padding: var(--space-12) var(--space-24);
            border: none;
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--duration-normal);
            font-family: var(--font-family-base);
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-8);
            min-width: fit-content;
        }

        .btn-primary {
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: var(--color-secondary);
            color: var(--color-text);
        }

        .btn-danger {
            background: var(--color-error);
            color: white;
        }

        .btn-group {
            display: flex;
            gap: var(--space-12);
            flex-wrap: wrap;
            margin-top: var(--space-20);
        }

        .table-container {
            background: white;
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-card-border);
            overflow: hidden;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size-sm);
        }

        thead {
            background: var(--color-gray-200);
            border-bottom: 2px solid var(--color-border);
        }

        th {
            padding: var(--space-12);
            text-align: left;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
        }

        td {
            padding: var(--space-12);
            border-bottom: 1px solid var(--color-card-border);
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-16);
            margin-bottom: var(--space-20);
        }

        .summary-card {
            background: white;
            padding: var(--space-20);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-card-border);
            text-align: center;
        }

        .summary-card-value {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            margin: 0 0 var(--space-8) 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            max-width: 450px;
            width: 90%;
        }

        .settings-item {
            background: white;
            padding: var(--space-16);
            border-radius: var(--radius-base);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--color-card-border);
            margin-bottom: var(--space-8);
        }

        .badge {
            display: inline-block;
            padding: var(--space-4) var(--space-8);
            background: var(--color-secondary);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        .bands-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: var(--space-12);
            margin: var(--space-16) 0;
        }

        .band-block {
            background: white;
            border: 2px solid var(--color-primary);
            border-radius: var(--radius-md);
            padding: var(--space-12);
            text-align: center;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .band-input {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            border: none;
            border-bottom: 2px solid var(--color-primary);
            background: transparent;
            text-align: center;
            width: 100%;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--color-success);
            color: white;
            padding: var(--space-16) var(--space-24);
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .filter-section {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-20);
            margin-bottom: var(--space-20);
            border: 1px solid var(--color-card-border);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-12);
        }

        @media (max-width: 768px) {
            .form-grid, .user-selection { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="userSelectionScreen" class="container" style="padding-top: var(--space-32);">
            <h1 style="text-align: center; font-size: var(--font-size-3xl); margin-bottom: var(--space-32);">Select Category</h1>
            <div class="user-selection" id="userSelectionGrid"></div>
        </div>

        <div id="mainApp" style="display: none;">
            <div class="header">
                <h1 class="header-title">Band Entry Management</h1>
                <div class="header-right">
                    <div class="user-indicator">Logged in as: <strong id="currentUserDisplay"></strong></div>
                    <button class="user-switch" onclick="switchUser()">Switch User</button>
                </div>
            </div>

            <div style="border-bottom: 1px solid var(--color-border); background: white;">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('entry')">üìù Entry Form</button>
                    <button class="tab" onclick="switchTab('viewData')">üìä View Data</button>
                    <button class="tab" onclick="switchTab('settings')" id="adminTab" style="display: none;">‚öôÔ∏è Settings</button>
                </div>
            </div>

            <div class="container">
                <div id="entryPage" class="page active">
                    <div class="form-section">
                        <h2 class="form-title">Record New Entry</h2>
                        <div class="form-group" style="margin-bottom: var(--space-20);">
                            <label class="form-label required">Current Band No.</label>
                            <input type="number" id="currentBandNo" class="form-control" placeholder="e.g., 101">
                        </div>
                        <form id="entryForm">
                            <input type="hidden" id="pendingBandNumbers" value="[]">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label required">Name</label>
                                    <input type="text" id="name" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label required">Zone</label>
                                    <select id="zone" class="form-control" required onchange="updateCommunities()">
                                        <option value="">Select zone</option>
                                        <option value="1">Zone 1</option><option value="2">Zone 2</option>
                                        <option value="3A">Zone 3A</option><option value="3B">Zone 3B</option>
                                        <option value="4A">Zone 4A</option><option value="4B">Zone 4B</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label required">Community</label>
                                    <select id="community" class="form-control" required><option value="">Select community</option></select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label required">Number of Bands</label>
                                    <input type="number" id="numBands" class="form-control" min="1" required onchange="calculateCost()">
                                </div>
                            </div>
                            <div class="bands-grid" id="bandsGrid"></div>
                            <div class="payment-section" style="background: var(--color-secondary); padding: var(--space-16); border-radius: var(--radius-base); margin: var(--space-20) 0;">
                                <p style="font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); color: var(--color-primary); margin: 0;">‚Çπ<span id="totalAmount">0</span></p>
                                <p id="paymentBreakdown" style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--space-8);">0 bands √ó ‚Çπ50/band = ‚Çπ0</p>
                            </div>
                            <div class="btn-group">
                                <button type="submit" class="btn btn-primary">Submit Entry</button>
                                <button type="reset" class="btn btn-secondary" id="clearFormBtn">Clear Form</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="viewDataPage" class="page">
                    <div class="summary-cards">
                        <div class="summary-card">
                            <p class="summary-card-value" id="totalEntriesDisplay">0</p>
                            <p>Total Entries</p>
                        </div>
                        <div class="summary-card">
                            <p class="summary-card-value">‚Çπ<span id="totalRevenueDisplay">0</span></p>
                            <p>Total Revenue</p>
                        </div>
                    </div>
                    <div class="filter-section">
                        <div class="filter-grid">
                            <div class="form-group">
                                <label class="form-label">Search Name</label>
                                <input type="text" id="searchName" class="form-control" onkeyup="applyFilters()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Filter Date</label>
                                <input type="date" id="filterDate" class="form-control" onchange="applyFilters()">
                            </div>
                        </div>
                    </div>
                    <div style="margin-bottom: var(--space-20);">
                        <button class="btn btn-primary" onclick="downloadUserData('xlsx')">üì• Download Data (XLSX)</button>
                        <button class="btn btn-secondary" onclick="downloadUserData('csv')" style="margin-left: var(--space-12);">üì• Download CSV</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Band #</th>
                                    <th>Name</th>
                                    <th>Zone</th>
                                    <th>Community</th>
                                    <th>Amount</th>
                                    <th>Date</th>
                                    <th id="userHeader" style="display:none">User</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="settingsPage" class="page">
                    <div class="form-section">
                        <h2 class="form-title">Admin Management</h2>
                        <div class="admin-section">
                            <button class="btn btn-primary" onclick="showCreateUserModal()">+ Create New User</button>
                            <button class="btn btn-secondary" onclick="showManageUsersModal()" style="margin-left: 10px;">Manage Existing Users</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <h2>Create New Profile</h2>
            <input type="text" id="newUsername" class="form-control" placeholder="Username" style="margin-bottom:12px">
            <input type="password" id="newPassword" class="form-control" placeholder="Password" style="margin-bottom:12px">
            <label class="form-label">Assign Category</label>
            <select id="newUserRole" class="form-control" style="margin-bottom:20px">
                <option value="Zonal Coordinator">Zonal Coordinator</option>
                <option value="Desk">Desk</option>
                <option value="Church Office">Church Office</option>
            </select>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="createUser()">Create</button>
                <button class="btn btn-secondary" onclick="closeModal('createUserModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <h2>Edit User Profile</h2>
            <input type="hidden" id="editUserId">
            <label class="form-label">Username</label>
            <input type="text" id="editUsernameField" class="form-control" style="margin-bottom:12px">
            <label class="form-label">Password</label>
            <input type="text" id="editPasswordField" class="form-control" style="margin-bottom:12px">
            <label class="form-label">Category</label>
            <select id="editUserRole" class="form-control" style="margin-bottom:20px">
                <option value="Zonal Coordinator">Zonal Coordinator</option>
                <option value="Desk">Desk</option>
                <option value="Church Office">Church Office</option>
            </select>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="saveEditedUser()">Save Changes</button>
                <button class="btn btn-secondary" onclick="closeModal('editUserModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="userPasswordModal" class="modal">
        <div class="modal-content">
            <h2>Login</h2>
            <p id="userPasswordPrompt" style="margin-bottom: 12px; color: var(--color-slate-500)"></p>
            <input type="password" id="userPassword" class="form-control" placeholder="Password" style="margin-bottom:20px">
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="verifyUserPassword()">Login</button>
                <button class="btn btn-secondary" onclick="closeUserPasswordModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="adminPasswordModal" class="modal">
        <div class="modal-content">
            <h2>Admin Login</h2>
            <input type="password" id="adminPassword" class="form-control" placeholder="Admin Password" style="margin-bottom:20px">
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="verifyAdminPassword()">Verify</button>
                <button class="btn btn-secondary" onclick="closeAdminModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="manageUsersModal" class="modal">
        <div class="modal-content" style="max-width: 550px">
            <h2>Manage Users</h2>
            <div id="usersList" style="max-height: 350px; overflow-y: auto; margin-bottom: 20px"></div>
            <button class="btn btn-secondary" onclick="closeModal('manageUsersModal')">Close</button>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        const communities = {
            '1': ['Morning Star', 'St. Andrew', 'Holy Trinity', 'St. Ann & St. Michael', 'Divya Jyothi', 'Unknown'],
            '2': ['Our Lady of Velankani', 'St. Anne', 'St. John', 'Holy Cross', 'St. Sebastian', 'Immaculate Conception', 'Unknown'],
            '3A': ['Divine Angel', 'Ave Maria', 'Unknown'],
            '3B': ['Our Lady of Rosary', 'Our Lady of Nazareth', 'Mother Theresa', 'St. Thomas', 'St. Francis Xavier', 'St. Anthony', 'Holy Cross', 'Unknown'],
            '4A': ['Gonsalo Gracia', 'Servers', 'St. Luke', 'St. Theresa', 'Don Bosco', 'Unknown'],
            '4B': ['St. Joseph', 'St. Anthony', 'St. Peter', 'Dominic Savio', 'Unknown'],
            'Other': ['Other', 'Unknown']
        };

        let currentUser = null, isAdmin = false, selectedCategory = null, users = {}, allEntries = [], filteredEntries = [];

        async function initApp() {
            await loadUsers();
            if (!currentUser) {
                document.getElementById('userSelectionScreen').style.display = 'block';
                document.getElementById('mainApp').style.display = 'none';
                displayCategorySelection();
            } else {
                document.getElementById('userSelectionScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                updateUI();
            }
        }

        async function loadUsers() {
            try {
                const res = await fetch(`${API_BASE}/manage-users`);
                const r = await res.json();
                users = {};
                r.data.forEach(u => { users[u.username] = u; }); // Legacy role || 'Desk' is handled in backend GET
            } catch (e) { console.error("User load error", e); }
        }

        function displayCategorySelection() {
            const grid = document.getElementById('userSelectionGrid'); grid.innerHTML = '';
            document.querySelector('#userSelectionScreen h1').textContent = 'Select Category';
            const cats = [{id:'Zonal Coordinator', icon:'üìç'}, {id:'Desk', icon:'üñ•Ô∏è'}, {id:'Church Office', icon:'‚õ™'}];
            cats.forEach(c => {
                const card = document.createElement('div'); card.className = 'user-card';
                card.onclick = () => { selectedCategory = c.id; displayUserSelection(); };
                card.innerHTML = `<div class="user-card-icon">${c.icon}</div><p>${c.id}</p>`;
                grid.appendChild(card);
            });
            const admin = document.createElement('div'); admin.style.gridColumn = '1/-1'; admin.style.textAlign='center';
            admin.innerHTML = `<button class="btn btn-secondary" onclick="selectUser('admin')">üë®‚Äçüíº Admin Login</button>`;
            grid.appendChild(admin);
        }

        function displayUserSelection() {
            const grid = document.getElementById('userSelectionGrid'); grid.innerHTML = '';
            document.querySelector('#userSelectionScreen h1').textContent = `Category: ${selectedCategory}`;
            const back = document.createElement('div'); back.style.gridColumn = '1/-1';
            back.innerHTML = `<button class="btn btn-sm btn-secondary" onclick="selectedCategory=null; displayCategorySelection();">‚Üê Back to Categories</button>`;
            grid.appendChild(back);
            Object.keys(users).forEach(u => {
                const role = users[u].role || 'Desk'; // Safeguard
                if (role === selectedCategory && !users[u].isAdmin) {
                    const card = document.createElement('div'); card.className = 'user-card'; card.onclick = () => selectUser(u);
                    card.innerHTML = `<div class="user-card-icon">üë§</div><p>${u}</p>`;
                    grid.appendChild(card);
                }
            });
        }

        function selectUser(u) {
            if (u === 'admin') { document.getElementById('adminPasswordModal').classList.add('active'); }
            else { 
                document.getElementById('userPasswordPrompt').textContent = `Logging in as: ${u}`; 
                document.getElementById('userPasswordModal').classList.add('active'); 
                document.getElementById('userPassword').dataset.user = u; 
            }
        }

        async function verifyUserPassword() {
            const u = document.getElementById('userPassword').dataset.user;
            if (users[u].password === document.getElementById('userPassword').value) {
                currentUser = u; isAdmin = false; closeUserPasswordModal(); initApp(); loadEntries();
            } else { alert('Incorrect password'); }
        }

        async function verifyAdminPassword() {
            if (document.getElementById('adminPassword').value === 'admin123') {
                currentUser = 'admin'; isAdmin = true; closeAdminModal(); initApp(); loadEntries();
            } else { alert('Incorrect password'); }
        }

        async function loadEntries() {
            const u = isAdmin ? 'all' : currentUser;
            try {
                const res = await fetch(`${API_BASE}/get-entries?userId=${u}`); 
                const r = await res.json();
                allEntries = r.data || []; 
                applyFilters();
            } catch (e) { console.error("Load entries error", e); }
        }

        function applyFilters() {
            const s = document.getElementById('searchName').value.toLowerCase();
            const d = document.getElementById('filterDate').value;
            filteredEntries = allEntries.filter(e => {
                if (s && !e.name.toLowerCase().includes(s)) return false;
                if (d && new Date(e.createdAt).toLocaleDateString('en-CA') !== d) return false;
                return true;
            });
            updateDataTable(filteredEntries);
        }

        function updateDataTable(data) {
            const tb = document.getElementById('dataTableBody');
            document.getElementById('userHeader').style.display = isAdmin ? 'table-cell' : 'none';
            if (data.length === 0) {
                tb.innerHTML = '<tr><td colspan="9" style="text-align:center">No records found.</td></tr>';
            } else {
                tb.innerHTML = data.map(e => `
                    <tr>
                        <td>#${e.bandNo}</td><td>${e.name}</td><td>${e.zone}</td><td>${e.community}</td><td>‚Çπ${e.amount}</td>
                        <td>${new Date(e.createdAt).toLocaleDateString('en-IN')}</td>
                        ${isAdmin ? `<td>${e.userId}</td>` : ''}
                        <td><button class="btn btn-sm btn-danger" onclick="deleteEntry('${e._id}')">Delete</button></td>
                    </tr>`).join('');
            }
            updateSummary(data); // Ensures counts are accurate for the current profile view
        }

        function updateSummary(data) {
            document.getElementById('totalEntriesDisplay').textContent = data.length;
            document.getElementById('totalRevenueDisplay').textContent = data.reduce((a, b) => a + (b.amount || 0), 0);
        }

        // --- EXPORT FIXES ---
        async function downloadUserData(format) {
            const entriesToExport = filteredEntries.length > 0 ? filteredEntries : allEntries;
            if (entriesToExport.length === 0) { alert('No data available to export'); return; }
            const filename = `${currentUser}_bands_data.${format}`;
            downloadCSV(entriesToExport, filename, isAdmin);
        }

        function downloadCSV(data, filename, includeUser = false) {
            let csv = 'Band No.,Name,Zone,Community,Amount,Date' + (includeUser ? ',User\n' : '\n');
            data.forEach(e => {
                const date = new Date(e.createdAt).toLocaleDateString('en-IN');
                const escapedName = e.name.replace(/"/g, '""');
                const escapedComm = e.community.replace(/"/g, '""');
                csv += `${e.bandNo},"${escapedName}",${e.zone},"${escapedComm}",${e.amount},${date}` + (includeUser ? `,${e.userId}\n` : '\n');
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- USER MGMT FIXES ---
        async function createUser() {
            const body = {
                username: document.getElementById('newUsername').value.trim(),
                password: document.getElementById('newPassword').value.trim(),
                role: document.getElementById('newUserRole').value
            };
            if (!body.username || !body.password) return alert('Username/Password required');
            const res = await fetch(`${API_BASE}/manage-users`, { method: 'POST', body: JSON.stringify(body) });
            if (res.ok) { closeModal('createUserModal'); showToast(`Created user: ${body.username}`); await loadUsers(); }
            else alert('Failed to create user');
        }

        function openEditUserModal(username) {
            const u = users[username];
            document.getElementById('editUserId').value = u._id;
            document.getElementById('editUsernameField').value = username;
            document.getElementById('editPasswordField').value = u.password;
            document.getElementById('editUserRole').value = u.role || 'Desk';
            document.getElementById('editUserModal').classList.add('active');
        }

        async function saveEditedUser() {
            const body = {
                id: document.getElementById('editUserId').value,
                username: document.getElementById('editUsernameField').value.trim(),
                password: document.getElementById('editPasswordField').value.trim(),
                role: document.getElementById('editUserRole').value
            };
            const res = await fetch(`${API_BASE}/manage-users`, { method: 'PUT', body: JSON.stringify(body) });
            if (res.ok) { closeModal('editUserModal'); showToast('User updated'); await loadUsers(); showManageUsersModal(); }
            else alert('Update failed');
        }

        function showManageUsersModal() {
            const list = document.getElementById('usersList'); list.innerHTML = '';
            Object.keys(users).forEach(u => {
                if (!users[u].isAdmin) {
                    const item = document.createElement('div'); item.className = 'settings-item';
                    item.innerHTML = `
                        <div style="flex:1">
                            <div class="settings-item-title">${u} <span class="badge">${users[u].role || 'Desk'}</span></div>
                            <div class="settings-item-desc">Pass: ${users[u].password}</div>
                        </div>
                        <div class="action-btns">
                            <button class="btn btn-sm btn-secondary" onclick="openEditUserModal('${u}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser('${u}')">Delete</button>
                        </div>`;
                    list.appendChild(item);
                }
            });
            document.getElementById('manageUsersModal').classList.add('active');
        }

        async function deleteUser(u) {
            if (confirm(`Delete user ${u}?`)) {
                await fetch(`${API_BASE}/manage-users?username=${u}`, { method: 'DELETE' });
                await loadUsers(); showManageUsersModal();
            }
        }

        // --- UI HELPERS ---
        function updateUI() {
            document.getElementById('currentUserDisplay').textContent = currentUser;
            document.getElementById('adminTab').style.display = isAdmin ? 'block' : 'none';
        }
        function showToast(m) {
            const t = document.createElement('div'); t.className = 'toast'; t.textContent = m;
            document.body.appendChild(t); setTimeout(() => t.remove(), 3000);
        }
        function switchUser() { currentUser = null; isAdmin = false; initApp(); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function closeAdminModal() { closeModal('adminPasswordModal'); }
        function closeUserPasswordModal() { closeModal('userPasswordModal'); }
        function switchTab(t) { 
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); 
            document.getElementById(t + 'Page').classList.add('active'); 
            document.querySelectorAll('.tab').forEach(ta => ta.classList.remove('active')); 
            event.target.classList.add('active');
            if (t === 'viewData') loadEntries();
        }
        function updateCommunities() {
            const z = document.getElementById('zone').value; const c = document.getElementById('community');
            c.innerHTML = '<option value="">Select community</option>';
            if(communities[z]) communities[z].forEach(co => { const o = document.createElement('option'); o.value=`Zone ${z} - ${co}`; o.textContent=`Zone ${z} - ${co}`; c.appendChild(o); });
        }
        function calculateCost() { 
            const n = document.getElementById('numBands').value; 
            document.getElementById('totalAmount').textContent = n * 50; 
            document.getElementById('paymentBreakdown').textContent = `${n} bands √ó ‚Çπ50/band = ‚Çπ${n * 50}`;
            displayBandBlocks(parseInt(n));
        }
        function displayBandBlocks(count) {
            const start = parseInt(document.getElementById('currentBandNo').value) || 0;
            const grid = document.getElementById('bandsGrid'); grid.innerHTML = '';
            const nums = [];
            for (let i = 0; i < count; i++) {
                nums.push(start + i);
                const b = document.createElement('div'); b.className = 'band-block';
                b.innerHTML = `<input type="number" class="band-input" value="${start + i}"><p style="font-size:10px">Band #</p>`;
                grid.appendChild(b);
            }
            document.getElementById('pendingBandNumbers').value = JSON.stringify(nums);
        }

        async function addEntry(e) {
            e.preventDefault();
            const body = {
                userId: currentUser,
                name: document.getElementById('name').value.trim(),
                zone: document.getElementById('zone').value,
                community: document.getElementById('community').value,
                bands: JSON.parse(document.getElementById('pendingBandNumbers').value),
                amountPerBand: 50
            };
            const res = await fetch(`${API_BASE}/save-entry`, { method: 'POST', body: JSON.stringify(body) });
            const r = await res.json();
            if (r.success) {
                showToast(`Success: Saved ${body.bands.length} bands`);
                document.getElementById('entryForm').reset();
                document.getElementById('bandsGrid').innerHTML = '';
                document.getElementById('currentBandNo').value = Math.max(...body.bands) + 1;
            } else alert(r.error);
        }

        async function deleteEntry(id) {
            if (confirm('Delete entry?')) {
                await fetch(`${API_BASE}/delete-entry?id=${id}`, { method: 'DELETE' });
                loadEntries();
            }
        }

        function showCreateUserModal() { document.getElementById('createUserModal').classList.add('active'); }
        
        document.getElementById('entryForm').addEventListener('submit', addEntry);
        initApp();
    </script>
</body>
</html>