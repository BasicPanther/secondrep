<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MFN 2026 Band Management</title>
    <style>
        :root {
            --color-teal: #21808d;
            --color-red: #c0152f;
            --color-slate: #13343b;
            --color-border: rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, Helvetica, Arial, sans-serif; background: #fcfcf9; color: #13343b; }
        
        /* Header */
        .header { background: white; border-bottom: 1px solid var(--color-border); padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-size: 20px; font-weight: bold; color: var(--color-teal); margin: 0; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }

        /* Legacy Grid Fallback using Flexbox */
        .user-selection { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; padding: 30px 0; }
        .user-card { background: white; border: 2px solid #ddd; border-radius: 12px; padding: 25px; cursor: pointer; text-align: center; width: 200px; margin-bottom: 10px; }
        .user-card:hover { border-color: var(--color-teal); }
        .user-card-icon { font-size: 40px; margin-bottom: 10px; }
        .user-card-name { font-weight: 600; }

        /* Tabs */
        .tabs { display: flex; background: white; border-bottom: 1px solid #ddd; overflow-x: auto; }
        .tab { padding: 15px 20px; cursor: pointer; border: none; background: none; font-weight: 600; color: #666; white-space: nowrap; }
        .tab.active { color: var(--color-teal); border-bottom: 3px solid var(--color-teal); }

        .page { display: none; padding: 20px 0; }
        .page.active { display: block; }

        /* Cards */
        .card { background: white; border-radius: 12px; padding: 20px; border: 1px solid #eee; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .form-grid { display: flex; flex-wrap: wrap; gap: 15px; }
        .form-group { flex: 1; min-width: 250px; display: flex; flex-direction: column; margin-bottom: 15px; }
        .form-label { font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #555; }
        .form-control { padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; -webkit-appearance: none; }

        /* Buttons */
        .btn { padding: 12px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 14px; text-align: center; display: inline-block; }
        .btn-primary { background: var(--color-teal); color: white; }
        .btn-secondary { background: #eee; color: #333; }
        .btn-danger { background: var(--color-red); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }

        /* Table Responsive */
        .table-container { background: white; border-radius: 12px; overflow-x: auto; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #f4f4f4; padding: 12px; font-size: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }

        /* Band Blocks */
        .bands-grid { display: flex; flex-wrap: wrap; gap: 10px; margin: 20px 0; }
        .band-block { border: 2px solid var(--color-teal); border-radius: 8px; padding: 10px; text-align: center; width: 100px; }
        .band-num { font-size: 18px; font-weight: bold; color: var(--color-teal); }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 25px; width: 90%; max-width: 500px; }

        /* Toast Popup */
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; border-radius: 10px; z-index: 2000; color: white; display: none; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .toast.error { background: var(--color-red); }
        .toast.success { background: var(--color-teal); }

        .stat-card { flex: 1; min-width: 200px; background: white; padding: 20px; border-radius: 12px; text-align: center; border-top: 4px solid var(--color-teal); border: 1px solid #ddd; margin-bottom: 20px; }
        .stat-value { font-size: 28px; font-weight: 800; color: var(--color-teal); }
    </style>
</head>
<body>

    <div id="loginScreen" class="container">
        <h1 style="text-align: center; margin-top: 40px; color: var(--color-teal);">MFN 2026 Band Management</h1>
        <p id="selectionPath" style="text-align: center; font-weight: bold; color: #666;"></p>
        <div id="userSelectionGrid" class="user-selection"></div>
    </div>

    <div id="mainApp" style="display: none;">
        <div class="header">
            <h1 class="header-title">MFN 2026</h1>
            <div style="display: flex; align-items: center;">
                <span id="currentUserDisplay" style="margin-right:15px; font-weight:bold;"></span>
                <button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" id="tab-entry" onclick="showPage('entryPage')">Entry Form</div>
            <div class="tab" id="tab-data" onclick="showPage('dataPage')">Explorer</div>
            <div class="tab" id="adminTab" style="display: none;" onclick="showPage('adminPage')">Settings</div>
        </div>

        <div class="container">
            <div id="entryPage" class="page active">
                <div class="card">
                    <h2>Record New Entry</h2>
                    <div class="form-group">
                        <label class="form-label">Start Band #</label>
                        <input type="number" id="startBand" class="form-control" oninput="updateBandPreview()">
                    </div>
                    <form id="entryForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Recipient Name</label>
                                <input type="text" id="recName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Zone</label>
                                <select id="recZone" class="form-control" required onchange="populateCommunities('recComm', this.value)">
                                    <option value="">Select Zone</option>
                                    <option value="1">Zone 1</option><option value="2">Zone 2</option>
                                    <option value="3A">Zone 3A</option><option value="3B">Zone 3B</option>
                                    <option value="4A">Zone 4A</option><option value="4B">Zone 4B</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Community</label>
                                <select id="recComm" class="form-control" required></select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Quantity</label>
                                <input type="number" id="qty" class="form-control" min="1" placeholder="Enter qty" oninput="updateBandPreview()">
                            </div>
                        </div>
                        <div id="bandsPreview" class="bands-grid"></div>
                        <div style="background: #13343b; color: white; padding: 20px; border-radius: 12px; display: flex; justify-content: space-between; margin: 20px 0;">
                            <span>Total Due:</span>
                            <span style="font-size: 24px; font-weight: bold;">‚Çπ<span id="calcTotal">0</span></span>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%">Save Entry</button>
                    </form>
                </div>
            </div>

            <div id="dataPage" class="page">
                <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                    <div class="stat-card"><div class="stat-value" id="totalEntriesDisplay">0</div><div>Entries</div></div>
                    <div class="stat-card"><div class="stat-value">‚Çπ<span id="totalRevenueDisplay">0</span></div><div>Revenue</div></div>
                </div>
                <div class="card">
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Search</label><input type="text" id="search" class="form-control" onkeyup="filterTable()"></div>
                        <div class="form-group"><label class="form-label">Date</label><input type="date" id="dateFilter" class="form-control" onchange="filterTable()"></div>
                    </div>
                    <div id="adminFilters" style="display:none; border-top: 1px solid #eee; padding-top:15px; margin-top:10px;">
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Category</label><select id="fCat" class="form-control" onchange="filterTable()"><option value="all">All</option><option value="Zone">Zone</option><option value="Desk">Desk</option><option value="Church Office">Office</option></select></div>
                            <div class="form-group"><label class="form-label">Operator</label><select id="fOper" class="form-control" onchange="filterTable()"></select></div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-secondary btn-sm" onclick="exportCSV()">Export CSV</button>
                        <button class="btn btn-secondary btn-sm" onclick="loadEntries()">Refresh</button>
                    </div>
                    <div class="table-container" style="margin-top: 20px;">
                        <table>
                            <thead><tr><th>Band #</th><th>Name</th><th>Zone</th><th>Community</th><th>Amount</th><th>Date</th><th id="adminCol" style="display:none">Operator</th><th>Actions</th></tr></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="adminPage" class="page">
                <div class="card">
                    <h3>User Management</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="openModal('addUserModal')">+ Add User</button>
                        <button class="btn btn-secondary" onclick="renderUserList()">Manage Users</button>
                    </div>
                    <hr>
                    <button class="btn btn-danger" onclick="clearDatabase()">Wipe All Records</button>
                </div>
            </div>
        </div>
    </div>

    <div id="passwordModal" class="modal"><div class="modal-content"><h2 id="loginTitle">Login</h2><div class="form-group"><label class="form-label">Password</label><input type="password" id="loginPass" class="form-control"></div><div style="margin-top: 20px; display: flex; gap: 10px;"><button class="btn btn-primary" onclick="processLogin()">Login</button><button class="btn btn-secondary" onclick="closeModal('passwordModal')">Cancel</button></div></div></div>

    <div id="addUserModal" class="modal"><div class="modal-content"><h2>New User</h2><div class="form-group"><label class="form-label">Role</label><select id="newRole" class="form-control" onchange="handleRoleChange(this.value)"><option value="Desk">Desk</option><option value="Church Office">Office</option><option value="Zone">Zone</option></select></div><div id="zoneSubField" class="form-group" style="display:none"><label class="form-label">Select Zone</label><select id="newUserZone" class="form-control" onchange="populateCommunityUsernames(this.value)"></select></div><div class="form-group" id="unameContainer"><label class="form-label">Username</label><input type="text" id="newUnameInput" class="form-control"></div><div class="form-group" id="passContainer"><label class="form-label">Password</label><input type="text" id="newPassInput" class="form-control"></div><button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="submitUser()">Save User</button></div></div>

    <div id="editEntryModal" class="modal"><div class="modal-content"><h2>Edit Record</h2><input type="hidden" id="editEntryId"><div class="form-group"><label class="form-label">Band #</label><input type="number" id="eBand" class="form-control"></div><div class="form-group"><label class="form-label">Name</label><input type="text" id="eName" class="form-control"></div><div class="modal-buttons" style="display:flex; gap:10px;"><button class="btn btn-primary" onclick="submitEntryUpdate()">Update</button><button class="btn btn-secondary" onclick="closeModal('editEntryModal')">Cancel</button></div></div></div>

    <div id="forcePassModal" class="modal"><div class="modal-content"><h2>Update Password</h2><p>Please change your default password.</p><input type="password" id="newSecurePass" class="form-control" placeholder="New Password"><button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="applyForceChange()">Update</button></div></div>

    <div id="userManageModal" class="modal"><div class="modal-content"><h2>System Users</h2><div id="userListBody" style="max-height: 300px; overflow-y: auto;"></div><button class="btn btn-secondary" style="margin-top:20px; width:100%" onclick="closeModal('userManageModal')">Close</button></div></div>

    <div id="toast" class="toast"></div>

    <script>
        // Use traditional function declarations and var/let for compatibility
        var API_URL = '/api';
        var communitiesMap = {
            '1': ['Morning Star', 'St. Andrew', 'Holy Trinity', 'St. Ann & St. Michael', 'Divya Jyothi'],
            '2': ['Our Lady of Velankani', 'St. Anne', 'St. John', 'Holy Cross', 'St. Sebastian', 'Immaculate Conception'],
            '3A': ['Divine Angel', 'Ave Maria'],
            '3B': ['Our Lady of Rosary', 'Our Lady of Nazareth', 'Mother Theresa', 'St. Thomas', 'St. Francis Xavier', 'St. Anthony', 'Holy Cross'],
            '4A': ['Gonsalo Gracia', 'Servers', 'St. Luke', 'St. Theresa', 'Don Bosco'],
            '4B': ['St. Joseph', 'St. Anthony', 'St. Peter', 'Dominic Savio'],
            'Other': ['External', 'Other']
        };

        var appState = { user: null, isAdmin: false, users: {}, entries: [], loginCat: null, loginZone: null };

        function init() {
            fetch(API_URL + '/manage-users')
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    appState.users = {};
                    data.data.forEach(function(u) { appState.users[u.username] = u; });
                    renderSelection();
                });
        }

        function renderSelection() {
            var grid = document.getElementById('userSelectionGrid');
            var path = document.getElementById('selectionPath');
            grid.innerHTML = '';

            if (!appState.loginCat) {
                path.innerText = "Select Category";
                var root = [{id:'Zone', icon:'üìç'}, {id:'Desk', icon:'üñ•Ô∏è'}, {id:'Church Office', icon:'‚õ™'}, {id:'Admin', icon:'üîê'}];
                root.forEach(function(c) {
                    var card = document.createElement('div');
                    card.className = 'user-card';
                    card.onclick = function() { if(c.id === 'Admin') openLogin('admin'); else { appState.loginCat = c.id; renderSelection(); } };
                    card.innerHTML = '<div class="user-card-icon">'+c.icon+'</div><div class="user-card-name">'+c.id+'</div>';
                    grid.appendChild(card);
                });
            } else if (appState.loginCat === 'Zone' && !appState.loginZone) {
                path.innerText = "Select Zone Group";
                ['1','2','3A','3B','4A','4B'].forEach(function(z) {
                    var card = document.createElement('div');
                    card.className = 'user-card';
                    card.onclick = function() { appState.loginZone = z; renderSelection(); };
                    card.innerHTML = '<div class="user-card-icon">üö©</div><div class="user-card-name">Zone '+z+'</div>';
                    grid.appendChild(card);
                });
                addBack();
            } else {
                path.innerText = "Select ID";
                Object.keys(appState.users).forEach(function(uname) {
                    var u = appState.users[uname];
                    var match = appState.loginCat === 'Zone' ? (u.role === 'Zone' && u.userZone === appState.loginZone) : (u.role === appState.loginCat);
                    if (match && !u.isAdmin) {
                        var card = document.createElement('div');
                        card.className = 'user-card';
                        card.onclick = function() { openLogin(uname); };
                        card.innerHTML = '<div class="user-card-icon">üë§</div><div class="user-card-name">'+uname+'</div>';
                        grid.appendChild(card);
                    }
                });
                addBack();
            }
        }

        function addBack() {
            var btn = document.createElement('button');
            btn.className = 'btn btn-secondary';
            btn.style.width = '100%';
            btn.innerText = '‚Üê Back';
            btn.onclick = function() { if(appState.loginZone) appState.loginZone = null; else appState.loginCat = null; renderSelection(); };
            document.getElementById('userSelectionGrid').appendChild(btn);
        }

        function openLogin(u) {
            document.getElementById('loginTitle').innerText = 'Login: ' + u;
            document.getElementById('loginPass').dataset.target = u;
            document.getElementById('loginPass').value = '';
            openModal('passwordModal');
        }

        function processLogin() {
            var target = document.getElementById('loginPass').dataset.target;
            var pass = document.getElementById('loginPass').value;
            var userObj = appState.users[target];

            if (target === 'admin' && pass === 'admin123') {
                appState.user = 'admin'; appState.isAdmin = true; finishLogin();
            } else if (userObj && userObj.password === pass) {
                appState.user = target; appState.isAdmin = false;
                closeModal('passwordModal');
                if (pass === 'olep@2026') openModal('forcePassModal'); else finishLogin();
            } else {
                showToast("Incorrect Password", true);
            }
        }

        function finishLogin() {
            closeModal('passwordModal');
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('currentUserDisplay').innerText = appState.user;
            document.getElementById('adminTab').style.display = appState.isAdmin ? 'block' : 'none';
            document.getElementById('adminFilters').style.display = appState.isAdmin ? 'block' : 'none';
            if (appState.isAdmin) showPage('dataPage'); else showPage('entryPage');
            loadEntries();
        }

        function logout() { window.location.reload(); }

        function loadEntries() {
            var scope = appState.isAdmin ? 'all' : appState.user;
            fetch(API_URL + '/get-entries?userId=' + scope)
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    appState.entries = data.data || [];
                    filterTable();
                });
        }

        function filterTable() {
            var s = document.getElementById('search').value.toLowerCase();
            var d = document.getElementById('dateFilter').value;
            var filtered = appState.entries.filter(function(e) {
                var nameMatch = e.name.toLowerCase().indexOf(s) > -1 || e.bandNo.toString().indexOf(s) > -1;
                var dateMatch = !d || new Date(e.createdAt).toLocaleDateString('en-CA') === d;
                
                if (appState.isAdmin) {
                    var cat = document.getElementById('fCat').value;
                    var uObj = appState.users[e.userId] || {};
                    if (cat !== 'all' && uObj.role !== cat) return false;
                }
                return nameMatch && dateMatch;
            });
            renderTable(filtered);
        }

        function renderTable(data) {
            var tb = document.getElementById('tableBody');
            document.getElementById('adminCol').style.display = appState.isAdmin ? 'table-cell' : 'none';
            
            var sort = document.getElementById('sortBy').value;
            if (sort === 'date-desc') data.sort(function(a,b) { return new Date(b.createdAt) - new Date(a.createdAt); });
            if (sort === 'band-asc') data.sort(function(a,b) { return a.bandNo - b.bandNo; });
            if (sort === 'name-asc') data.sort(function(a,b) { return a.name.localeCompare(b.name); });

            var html = '';
            data.forEach(function(e) {
                var dt = new Date(e.createdAt);
                var op = appState.isAdmin ? '<td>'+e.userId+'</td>' : '';
                html += '<tr><td>#'+e.bandNo+'</td><td>'+e.name+'</td><td>'+e.zone+'</td><td>'+e.community+'</td><td>‚Çπ'+e.amount+'</td><td>'+dt.toLocaleDateString()+'</td>'+op+'<td><button class="btn btn-sm btn-secondary" onclick="openEdit(\''+e._id+'\','+e.bandNo+',\''+e.name+'\')">Edit</button></td></tr>';
            });
            tb.innerHTML = html;
            document.getElementById('totalEntriesDisplay').innerText = data.length;
            var rev = 0; data.forEach(function(i){ rev += (i.amount || 0); });
            document.getElementById('totalRevenueDisplay').innerText = rev.toLocaleString();
        }

        function updateBandPreview() {
            var start = parseInt(document.getElementById('startBand').value) || 0;
            var q = parseInt(document.getElementById('qty').value) || 0;
            var container = document.getElementById('bandsPreview');
            container.innerHTML = '';
            for(var i=0; i<q; i++) {
                container.innerHTML += '<div class="band-block"><div class="band-num">'+(start+i)+'</div><div style="font-size:9px">BAND #</div></div>';
            }
            document.getElementById('calcTotal').innerText = (q * 50).toLocaleString();
        }

        document.getElementById('entryForm').onsubmit = function(e) {
            e.preventDefault();
            var start = parseInt(document.getElementById('startBand').value);
            var q = parseInt(document.getElementById('qty').value);
            if (!q) { showToast("Enter quantity", true); return; }

            var bands = []; for(var i=0; i<q; i++) bands.push(start+i);
            var payload = {
                userId: appState.user,
                name: document.getElementById('recName').value,
                zone: document.getElementById('recZone').value,
                community: document.getElementById('recComm').value,
                bands: bands,
                amountPerBand: 50
            };

            fetch(API_URL + '/save-entry', {
                method: 'POST',
                body: JSON.stringify(payload)
            }).then(function(res) {
                if (res.status === 409) { showToast("Duplicate Band Number Detected", true); }
                else {
                    showToast("Entry Saved");
                    document.getElementById('entryForm').reset();
                    document.getElementById('startBand').value = start + q;
                    updateBandPreview();
                    loadEntries();
                }
            });
        };

        function handleRoleChange(r) {
            var sub = document.getElementById('zoneSubField');
            var uCont = document.getElementById('unameContainer');
            if (r === 'Zone') {
                sub.style.display = 'block';
                document.getElementById('newUserZone').innerHTML = '<option value="">Select Zone</option>' + ['1','2','3A','3B','4A','4B'].map(function(v){return '<option value="'+v+'">'+v+'</option>';}).join('');
                uCont.innerHTML = '<label class="form-label">Community</label><select id="newUnameSelect" class="form-control"></select>';
            } else {
                sub.style.display = 'none';
                uCont.innerHTML = '<label class="form-label">Username</label><input type="text" id="newUnameInput" class="form-control">';
            }
        }

        function populateCommunityUsernames(z) {
            var s = document.getElementById('newUnameSelect');
            if(!s) return;
            s.innerHTML = '<option value="">Select Community</option>';
            if(communitiesMap[z]) communitiesMap[z].forEach(function(c){ s.innerHTML += '<option value="'+c+'">'+c+'</option>'; });
        }

        function submitUser() {
            var role = document.getElementById('newRole').value;
            var uname = (role === 'Zone') ? document.getElementById('newUnameSelect').value : document.getElementById('newUnameInput').value;
            var pass = (role === 'Zone') ? 'olep@2026' : document.getElementById('newPassInput').value;
            
            var p = { username: uname, role: role, userZone: document.getElementById('newUserZone').value || null, password: pass };
            fetch(API_URL + '/manage-users', {
                method: 'POST',
                body: JSON.stringify(p)
            }).then(function() { showToast("User Created"); closeModal('addUserModal'); init(); });
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function showToast(m, err) {
            var t = document.getElementById('toast');
            t.innerText = m;
            t.className = 'toast ' + (err ? 'error' : 'success');
            t.style.display = 'block';
            setTimeout(function(){ t.style.display = 'none'; }, 4000);
        }
        function showPage(pId) {
            document.querySelectorAll('.page').forEach(function(p){ p.classList.remove('active'); });
            document.getElementById(pId).classList.add('active');
            document.querySelectorAll('.tab').forEach(function(t){ t.classList.remove('active'); });
            document.getElementById('tab-' + pId.replace('Page', '')).classList.add('active');
            if(pId === 'dataPage') loadEntries();
        }
        function populateCommunities(id, z) {
            var s = document.getElementById(id);
            s.innerHTML = '<option value="">Select Community</option>';
            if(communitiesMap[z]) communitiesMap[z].forEach(function(c){ s.innerHTML += '<option value="'+c+'">'+c+'</option>'; });
        }
        function openEdit(id, b, n) {
            document.getElementById('editEntryId').value = id;
            document.getElementById('eBand').value = b;
            document.getElementById('eName').value = n;
            openModal('editEntryModal');
        }
        function submitEntryUpdate() {
            var p = { 
                id: document.getElementById('editEntryId').value, 
                newBandNo: parseInt(document.getElementById('eBand').value), 
                name: document.getElementById('eName').value,
                amount: 50
            };
            fetch(API_URL + '/update-entry', { method: 'PUT', body: JSON.stringify(p), headers: {'Content-Type':'application/json'} })
                .then(function() { closeModal('editEntryModal'); loadEntries(); showToast("Updated"); });
        }
        function exportCSV() {
            var csv = "\ufeffBand #,Recipient,Zone,Community,Amount,Date,Operator\n";
            appState.entries.forEach(function(e) {
                csv += e.bandNo + ',"' + e.name + '",' + e.zone + ',"' + e.community + '",' + e.amount + ',' + new Date(e.createdAt).toLocaleDateString() + ',' + e.userId + '\n';
            });
            var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", "MFN2026_Report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.onload = init;
    </script>
</body>
</html>