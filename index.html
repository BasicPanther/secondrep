<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MFN 2026 Band Management</title>
    <style>
        :root {
            --color-white: #ffffff;
            --color-cream-50: #fcfcf9;
            --color-cream-100: #fffffd;
            --color-gray-200: #f5f5f5;
            --color-slate-500: #626c71;
            --color-slate-900: #13343b;
            --color-teal-500: #21808d;
            --color-teal-600: #1d7480;
            --color-red-500: #c0152f;
            --color-red-400: #ff5459;
            --color-border: rgba(94, 82, 64, 0.2);
            --radius-base: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: var(--font-family); background: var(--color-cream-50); color: var(--color-slate-900); min-height: 100vh; }
        
        /* Header */
        .header { background: white; border-bottom: 1px solid var(--color-border); padding: 16px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .header-title { font-size: 22px; font-weight: 700; color: var(--color-teal-500); margin: 0; }
        .user-indicator { font-size: 14px; color: var(--color-slate-500); }

        .container { max-width: 1200px; margin: 0 auto; padding: 16px; width: 100%; }

        /* Login Selection UI */
        .user-selection { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; padding: 32px 0; }
        .user-card { background: white; border: 2px solid var(--color-border); border-radius: var(--radius-lg); padding: 30px 20px; cursor: pointer; transition: all 0.2s ease; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 160px; }
        .user-card:hover { border-color: var(--color-teal-500); transform: translateY(-4px); box-shadow: var(--shadow-md); }
        .user-card-icon { font-size: 3rem; margin-bottom: 12px; }
        .user-card-name { font-weight: 600; font-size: 16px; }

        /* Navigation Tabs */
        .tabs-container { border-bottom: 1px solid var(--color-border); background: white; }
        .tabs { display: flex; max-width: 1200px; margin: 0 auto; padding: 0 16px; }
        .tab { padding: 16px 24px; cursor: pointer; border: none; background: none; font-weight: 600; color: var(--color-slate-500); border-bottom: 3px solid transparent; transition: all 0.2s; }
        .tab.active { color: var(--color-teal-500); border-bottom-color: var(--color-teal-500); }
        .tab:hover { background: var(--color-gray-200); }

        .page { display: none; padding: 24px 0; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Components */
        .card { background: white; border-radius: var(--radius-lg); padding: 24px; border: 1px solid var(--color-border); box-shadow: var(--shadow-sm); margin-bottom: 24px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-label { font-size: 13px; font-weight: 700; color: var(--color-slate-500); text-transform: uppercase; letter-spacing: 0.02em; }
        .form-control { padding: 12px; border: 1px solid var(--color-border); border-radius: var(--radius-base); font-size: 15px; outline: none; transition: border 0.2s; }
        .form-control:focus { border-color: var(--color-teal-500); box-shadow: 0 0 0 3px rgba(33, 128, 141, 0.1); }
        
        .btn { padding: 12px 24px; border-radius: var(--radius-base); border: none; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; transition: 0.2s; font-family: inherit; }
        .btn-primary { background: var(--color-teal-500); color: white; }
        .btn-primary:hover { background: var(--color-teal-600); }
        .btn-secondary { background: var(--color-gray-200); color: var(--color-slate-900); }
        .btn-danger { background: var(--color-red-500); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 11px; border-radius: 6px; }

        /* Tables */
        .table-container { background: white; border-radius: var(--radius-lg); overflow-x: auto; border: 1px solid var(--color-border); box-shadow: var(--shadow-sm); }
        table { width: 100%; border-collapse: collapse; text-align: left; min-width: 1000px; }
        th { background: #f8f9fa; padding: 16px; font-size: 11px; text-transform: uppercase; color: var(--color-slate-500); font-weight: 800; letter-spacing: 0.05em; border-bottom: 2px solid #eee; }
        td { padding: 16px; border-bottom: 1px solid #f0f0f0; font-size: 13px; }
        tr:hover { background: #fcfcfc; }

        /* Summary Stats */
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .stat-card { background: white; padding: 24px; border-radius: var(--radius-lg); border: 1px solid var(--color-border); text-align: center; border-top: 4px solid var(--color-teal-500); }
        .stat-value { font-size: 32px; font-weight: 800; color: var(--color-teal-500); margin-bottom: 4px; }
        .stat-label { font-size: 11px; font-weight: 700; color: var(--color-slate-500); text-transform: uppercase; }

        /* Band Visualization */
        .bands-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 12px; margin: 24px 0; }
        .band-block { border: 2px solid var(--color-teal-500); border-radius: 10px; padding: 16px; text-align: center; background: white; box-shadow: var(--shadow-sm); }
        .band-num { font-size: 20px; font-weight: 800; color: var(--color-teal-500); }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(19, 52, 59, 0.8); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: var(--radius-lg); padding: 32px; width: 95%; max-width: 550px; position: relative; }

        /* Toast Popup */
        .toast { position: fixed; bottom: 30px; right: 30px; background: #13343b; color: white; padding: 16px 32px; border-radius: 10px; z-index: 2000; box-shadow: 0 10px 15px rgba(0,0,0,0.2); font-weight: 600; display: none; transition: 0.3s; }
        .toast.error { background: var(--color-red-500); }
        .toast.success { background: var(--color-teal-500); }

        .admin-filter-badge { background: #e0f2f1; color: #00796b; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; margin-bottom: 4px; display: inline-block; }
    </style>
</head>
<body>

    <div id="loginScreen" class="container">
        <h1 style="text-align: center; margin-top: 60px; color: var(--color-teal-500);">MFN 2026 Band Management</h1>
        <p id="selectionPath" style="text-align: center; font-weight: 700; font-size: 18px; margin-bottom: 40px; color: var(--color-slate-500);"></p>
        <div id="userSelectionGrid" class="user-selection"></div>
    </div>

    <div id="mainApp" style="display: none;">
        <div class="header">
            <h1 class="header-title">MFN 2026</h1>
            <div style="display: flex; gap: 20px; align-items: center;">
                <span id="currentUserDisplay" class="user-indicator"></span>
                <button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="tabs-container">
            <div class="tabs">
                <button class="tab active" id="tab-entry" onclick="showPage('entryPage')">üìù Entry Form</button>
                <button class="tab" id="tab-data" onclick="showPage('dataPage')">üìä Data Explorer</button>
                <button class="tab" id="adminTab" style="display: none;" onclick="showPage('adminPage')">‚öôÔ∏è Settings</button>
            </div>
        </div>

        <div class="container">
            <div id="entryPage" class="page active">
                <div class="card">
                    <h2 style="margin-top:0; color: var(--color-teal-500);">Record New Entry</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Starting Band Number</label>
                            <input type="number" id="startBand" class="form-control" placeholder="e.g. 1001" oninput="updateBandPreview()">
                        </div>
                    </div>
                    <form id="entryForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Recipient Name</label>
                                <input type="text" id="recName" class="form-control" placeholder="Full Name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Zone</label>
                                <select id="recZone" class="form-control" required onchange="populateCommunities('recComm', this.value)">
                                    <option value="">Select Zone</option>
                                    <option value="1">Zone 1</option><option value="2">Zone 2</option>
                                    <option value="3A">Zone 3A</option><option value="3B">Zone 3B</option>
                                    <option value="4A">Zone 4A</option><option value="4B">Zone 4B</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Community</label>
                                <select id="recComm" class="form-control" required><option value="">Select Zone first</option></select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Number of Bands</label>
                                <input type="number" id="qty" class="form-control" min="1" placeholder="Enter quantity" oninput="updateBandPreview()">
                            </div>
                        </div>
                        
                        <div id="bandsPreview" class="bands-grid"></div>

                        <div style="background: var(--color-slate-900); color: white; padding: 20px; border-radius: 12px; margin: 30px 0; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 11px; opacity: 0.7; font-weight: 800; text-transform: uppercase;">Total Collection Due</div>
                                <div style="font-size: 14px;" id="qtyDisplay">0 bands √ó ‚Çπ50</div>
                            </div>
                            <div style="font-size: 32px; font-weight: 800; color: var(--color-teal-300);">‚Çπ<span id="calcTotal">0</span></div>
                        </div>

                        <button type="submit" class="btn btn-primary" style="width: 100%;">Save Entry</button>
                    </form>
                </div>
            </div>

            <div id="dataPage" class="page">
                <div class="summary-cards">
                    <div class="stat-card">
                        <div class="stat-value" id="totalEntriesDisplay">0</div>
                        <div class="stat-label">Total Entries Found</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">‚Çπ<span id="totalRevenueDisplay">0</span></div>
                        <div class="stat-label">Calculated Revenue</div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-top:0; font-size: 14px; color: var(--color-teal-500);">üîç SEARCH & FILTERS</h3>
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">Search Name/Band</label><input type="text" id="search" class="form-control" onkeyup="filterTable()"></div>
                        <div class="form-group"><label class="form-label">Allocation Date</label><input type="date" id="dateFilter" class="form-control" onchange="filterTable()"></div>
                        <div class="form-group">
                            <label class="form-label">Sorting</label>
                            <select id="sortBy" class="form-control" onchange="filterTable()">
                                <option value="date-desc">Newest First</option>
                                <option value="band-asc">Band # (1 ‚Üí 999)</option>
                                <option value="band-desc">Band # (999 ‚Üí 1)</option>
                                <option value="name-asc">Name (A-Z)</option>
                            </select>
                        </div>
                    </div>

                    <div id="adminFilterContainer" style="display: none; border-top: 1px dashed var(--color-border); padding-top: 20px; margin-top: 10px;">
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label">Filter by Category</label><select id="filterCategory" class="form-control" onchange="handleAdminFilterChange()"><option value="all">All Categories</option><option value="Zone">Zone</option><option value="Desk">Desk</option><option value="Church Office">Church Office</option></select></div>
                            <div class="form-group"><label class="form-label">Filter by Zone</label><select id="filterZone" class="form-control" onchange="handleAdminFilterZoneChange()"><option value="all">All Zones</option><option value="1">Zone 1</option><option value="2">Zone 2</option><option value="3A">Zone 3A</option><option value="3B">Zone 3B</option><option value="4A">Zone 4A</option><option value="4B">Zone 4B</option><option value="Other">Other</option></select></div>
                            <div class="form-group"><label class="form-label">Filter by Community</label><select id="filterCommunity" class="form-control" onchange="filterTable()"><option value="all">All Communities</option></select></div>
                            <div class="form-group"><label class="form-label">Filter by Operator</label><select id="filterOperator" class="form-control" onchange="filterTable()"><option value="all">All Operators</option></select></div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button class="btn btn-secondary btn-sm" onclick="exportCSV()">üì• Export CSV</button>
                        <button class="btn btn-secondary btn-sm" onclick="loadEntries()">üîÑ Sync</button>
                        <button class="btn btn-secondary btn-sm" onclick="resetAllFilters()">‚úï Reset Filters</button>
                    </div>

                    <div class="table-container" style="margin-top: 24px;">
                        <table id="entryTable">
                            <thead>
                                <tr><th>Band #</th><th>Recipient</th><th>Zone</th><th>Community</th><th>Amount</th><th>Timestamp</th><th id="adminCol" style="display:none">Operator</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="adminPage" class="page">
                <div class="card">
                    <h2 style="margin-top:0">Administration</h2>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; border-left: 5px solid var(--color-teal-500); margin-bottom: 24px;">
                        <h3>Account Management</h3>
                        <div style="display: flex; gap: 12px; margin-top: 15px;">
                            <button class="btn btn-primary" onclick="openModal('addUserModal')">‚ûï Create Profile</button>
                            <button class="btn btn-secondary" onclick="renderManageUsersList()">üìã Manage Profiles</button>
                        </div>
                    </div>
                    <div style="background: #fff5f5; padding: 20px; border-radius: 12px; border-left: 5px solid var(--color-red-500);">
                        <h3 style="color: var(--color-red-500);">Danger Zone</h3>
                        <button class="btn btn-danger" onclick="clearDatabase()">‚ö†Ô∏è Wipe Records</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="passwordModal" class="modal"><div class="modal-content"><h2 id="loginTitle" style="color: var(--color-teal-500);">Authenticate</h2><div class="form-group"><label class="form-label">Password</label><input type="password" id="loginPass" class="form-control"></div><div class="modal-buttons" style="margin-top: 24px; display: flex; gap: 12px;"><button class="btn btn-primary" style="flex: 1" onclick="processLogin()">Login</button><button class="btn btn-secondary" style="flex: 1" onclick="closeModal('passwordModal')">Cancel</button></div></div></div>

    <div id="addUserModal" class="modal"><div class="modal-content"><h2 style="color: var(--color-teal-500);">New Profile</h2><div class="form-group" style="margin-bottom: 15px;"><label class="form-label">Role Category</label><select id="newRole" class="form-control" onchange="handleRoleChange(this.value)"><option value="Desk">Desk</option><option value="Church Office">Church Office</option><option value="Zone">Zone</option></select></div><div id="zoneSubField" class="form-group" style="display:none; margin-bottom: 15px;"><label class="form-label">Select Zone</label><select id="newUserZone" class="form-control" onchange="populateCommunityUsernames(this.value)"></select></div><div class="form-group"><label class="form-label">Username (Profile Name)</label><select id="newUsername" class="form-control"></select></div><p style="font-size: 11px; color: var(--color-slate-500); margin-top: 15px;">* Default password: <strong>olep@2026</strong></p><div class="modal-buttons" style="margin-top: 24px; display: flex; gap: 12px;"><button class="btn btn-primary" onclick="submitNewUser()">Save</button><button class="btn btn-secondary" onclick="closeModal('addUserModal')">Cancel</button></div></div></div>

    <div id="userManageModal" class="modal"><div class="modal-content" style="max-width: 600px;"><h2>Existing Profiles</h2><div id="userListBody" style="max-height: 400px; overflow-y: auto;"></div><button class="btn btn-secondary" style="margin-top:20px; width: 100%;" onclick="closeModal('userManageModal')">Close</button></div></div>

    <div id="editProfileModal" class="modal"><div class="modal-content"><h2>Edit Profile</h2><input type="hidden" id="editUserId"><div class="form-group"><label class="form-label">Username</label><input type="text" id="editProfileName" class="form-control"></div><div class="form-group"><label class="form-label">Password</label><input type="text" id="editProfilePass" class="form-control"></div><div class="modal-buttons"><button class="btn btn-primary" onclick="saveUserProfile()">Save</button><button class="btn btn-secondary" onclick="closeModal('editProfileModal')">Cancel</button></div></div></div>

    <div id="editEntryModal" class="modal"><div class="modal-content"><h2>Edit Entry</h2><input type="hidden" id="editEntryId"><div class="form-grid"><div class="form-group"><label class="form-label">Band #</label><input type="number" id="eBand" class="form-control"></div><div class="form-group"><label class="form-label">Recipient</label><input type="text" id="eName" class="form-control"></div><div class="form-group"><label class="form-label">Zone</label><select id="eZone" class="form-control" onchange="populateCommunities('eComm', this.value)"><option value="1">1</option><option value="2">2</option><option value="3A">3A</option><option value="3B">3B</option><option value="4A">4A</option><option value="4B">4B</option><option value="Other">Other</option></select></div><div class="form-group"><label class="form-label">Community</label><select id="eComm" class="form-control"></select></div></div><div class="modal-buttons"><button class="btn btn-primary" onclick="submitEntryUpdate()">Update</button><button class="btn btn-secondary" onclick="closeModal('editEntryModal')">Cancel</button></div></div></div>

    <div id="toast" class="toast"></div>

    <script>
        const API_URL = '/api';
        const communitiesMap = {
            '1': ['Morning Star', 'St. Andrew', 'Holy Trinity', 'St. Ann & St. Michael', 'Divya Jyothi'],
            '2': ['Our Lady of Velankani', 'St. Anne', 'St. John', 'Holy Cross', 'St. Sebastian', 'Immaculate Conception'],
            '3A': ['Divine Angel', 'Ave Maria'],
            '3B': ['Our Lady of Rosary', 'Our Lady of Nazareth', 'Mother Theresa', 'St. Thomas', 'St. Francis Xavier', 'St. Anthony', 'Holy Cross'],
            '4A': ['Gonsalo Gracia', 'Servers', 'St. Luke', 'St. Theresa', 'Don Bosco'],
            '4B': ['St. Joseph', 'St. Anthony', 'St. Peter', 'Dominic Savio'],
            'Other': ['General', 'Office', 'Other']
        };

        let appState = { currentUser: null, isAdmin: false, users: {}, entries: [], loginCat: null, loginZone: null };

        async function init() {
            try {
                const res = await fetch(`${API_URL}/manage-users`);
                const data = await res.json();
                appState.users = {};
                data.data.forEach(u => appState.users[u.username] = u);
                renderSelectionScreen();
            } catch (err) { console.error(err); }
        }

        function renderSelectionScreen() {
            const grid = document.getElementById('userSelectionGrid');
            const path = document.getElementById('selectionPath');
            grid.innerHTML = '';

            if (!appState.loginCat) {
                path.textContent = "Select Category";
                const rootCats = [{id: 'Zone', icon: 'üìç'}, {id: 'Desk', icon: 'üñ•Ô∏è'}, {id: 'Church Office', icon: '‚õ™'}, {id: 'Admin', icon: 'üîê'}];
                rootCats.forEach(cat => {
                    const card = document.createElement('div');
                    card.className = 'user-card';
                    card.onclick = () => { if(cat.id === 'Admin') triggerLogin('admin'); else { appState.loginCat = cat.id; renderSelectionScreen(); } };
                    card.innerHTML = `<div class="user-card-icon">${cat.icon}</div><div class="user-card-name">${cat.id}</div>`;
                    grid.appendChild(card);
                });
            } else if (appState.loginCat === 'Zone' && !appState.loginZone) {
                path.textContent = "Select Zone Group";
                ['1','2','3A','3B','4A','4B'].forEach(z => {
                    const card = document.createElement('div');
                    card.className = 'user-card';
                    card.onclick = () => { appState.loginZone = z; renderSelectionScreen(); };
                    card.innerHTML = `<div class="user-card-icon">üö©</div><div class="user-card-name">Zone ${z}</div>`;
                    grid.appendChild(card);
                });
                addBackNav();
            } else {
                path.textContent = `Select ${appState.loginZone || appState.loginCat} Profile`;
                Object.keys(appState.users).forEach(u => {
                    const user = appState.users[u];
                    const match = appState.loginCat === 'Zone' ? (user.role === 'Zone' && user.userZone === appState.loginZone) : (user.role === appState.loginCat);
                    if (match && !user.isAdmin) {
                        const card = document.createElement('div');
                        card.className = 'user-card';
                        card.onclick = () => triggerLogin(u);
                        card.innerHTML = `<div class="user-card-icon">üë§</div><div class="user-card-name">${u}</div>`;
                        grid.appendChild(card);
                    }
                });
                addBackNav();
            }
        }

        function addBackNav() {
            const btn = document.createElement('button'); btn.className = 'btn btn-secondary'; btn.style.marginTop = '30px'; btn.textContent = '‚Üê Back';
            btn.onclick = () => { if (appState.loginZone) appState.loginZone = null; else appState.loginCat = null; renderSelectionScreen(); };
            document.getElementById('userSelectionGrid').appendChild(btn);
        }

        function triggerLogin(u) {
            document.getElementById('loginTitle').textContent = `Login: ${u}`;
            document.getElementById('loginPass').dataset.targetUser = u;
            openModal('passwordModal');
        }

        async function processLogin() {
            const target = document.getElementById('loginPass').dataset.targetUser;
            const pass = document.getElementById('loginPass').value;
            if (target === 'admin' ? pass === 'admin123' : appState.users[target].password === pass) {
                appState.currentUser = target; appState.isAdmin = (target === 'admin');
                closeModal('passwordModal');
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('currentUserDisplay').textContent = target;
                document.getElementById('adminTab').style.display = appState.isAdmin ? 'block' : 'none';
                document.getElementById('adminFilterContainer').style.display = appState.isAdmin ? 'block' : 'none';
                if(appState.isAdmin) populateOperatorFilter();
                else showPage('entryPage');
                loadEntries();
            } else showToast("Invalid Password", true);
        }

        function logout() { location.reload(); }

        // --- Data Logic ---
        async function loadEntries() {
            const scope = appState.isAdmin ? 'all' : appState.currentUser;
            const res = await fetch(`${API_URL}/get-entries?userId=${scope}`);
            const data = await res.json();
            appState.entries = data.data || [];
            updateDataTable(appState.entries);
        }

        function filterTable() {
            const search = document.getElementById('search').value.toLowerCase();
            const dateVal = document.getElementById('dateFilter').value;
            
            const filtered = appState.entries.filter(e => {
                const matchSearch = e.name.toLowerCase().includes(search) || e.bandNo.toString().includes(search);
                const matchDate = !dateVal || new Date(e.createdAt).toLocaleDateString('en-CA') === dateVal;
                
                if (appState.isAdmin) {
                    const cat = document.getElementById('filterCategory').value;
                    const zone = document.getElementById('filterZone').value;
                    const comm = document.getElementById('filterCommunity').value;
                    const oper = document.getElementById('filterOperator').value;

                    const userObj = appState.users[e.userId] || { role: 'N/A' };
                    if (cat !== 'all' && userObj.role !== cat) return false;
                    if (zone !== 'all' && e.zone !== zone) return false;
                    if (comm !== 'all' && e.community !== comm) return false;
                    if (oper !== 'all' && e.userId !== oper) return false;
                }
                return matchSearch && matchDate;
            });
            updateDataTable(filtered);
        }

        function updateDataTable(data) {
            const tbody = document.getElementById('tableBody');
            document.getElementById('adminCol').style.display = appState.isAdmin ? 'table-cell' : 'none';
            const sortType = document.getElementById('sortBy').value;
            let sorted = [...data];
            if(sortType === 'date-desc') sorted.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            if(sortType === 'band-asc') sorted.sort((a,b) => a.bandNo - b.bandNo);
            if(sortType === 'band-desc') sorted.sort((a,b) => b.bandNo - a.bandNo);
            if(sortType === 'name-asc') sorted.sort((a,b) => a.name.localeCompare(b.name));

            tbody.innerHTML = sorted.map(e => {
                const dt = new Date(e.createdAt);
                const operatorHTML = appState.isAdmin ? `<td><span class="admin-filter-badge">${appState.users[e.userId]?.role || 'N/A'}</span><br>${e.userId}</td>` : '';
                return `<tr><td><strong>#${e.bandNo}</strong></td><td>${e.name}</td><td>${e.zone}</td><td>${e.community}</td><td>‚Çπ${e.amount}</td><td>${dt.toLocaleDateString()} <span style="font-size:10px; opacity:0.6;">${dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span></td>${operatorHTML}<td><div class="action-btns"><button class="btn btn-sm btn-secondary" onclick="openEditEntry('${e._id}','${e.bandNo}','${e.name}','${e.zone}','${e.community}')">Edit</button><button class="btn btn-sm btn-danger" onclick="deleteEntry('${e._id}')">Del</button></div></td></tr>`;
            }).join('');
            document.getElementById('totalEntriesDisplay').textContent = sorted.length;
            document.getElementById('totalRevenueDisplay').textContent = sorted.reduce((s,i) => s+(i.amount||0), 0).toLocaleString();
        }

        function populateOperatorFilter() {
            const select = document.getElementById('filterOperator');
            select.innerHTML = '<option value="all">All Operators</option>';
            Object.keys(appState.users).forEach(u => { if(!appState.users[u].isAdmin) select.innerHTML += `<option value="${u}">${u}</option>`; });
        }

        function handleAdminFilterChange() {
            const cat = document.getElementById('filterCategory').value;
            const operSelect = document.getElementById('filterOperator');
            operSelect.innerHTML = '<option value="all">All Operators</option>';
            Object.keys(appState.users).forEach(u => { if (!appState.users[u].isAdmin && (cat === 'all' || appState.users[u].role === cat)) operSelect.innerHTML += `<option value="${u}">${u}</option>`; });
            filterTable();
        }

        function handleAdminFilterZoneChange() {
            const zone = document.getElementById('filterZone').value;
            const commSelect = document.getElementById('filterCommunity');
            commSelect.innerHTML = '<option value="all">All Communities</option>';
            if (communitiesMap[zone]) communitiesMap[zone].forEach(c => commSelect.innerHTML += `<option value="${c}">${c}</option>`);
            filterTable();
        }

        function resetAllFilters() {
            document.getElementById('search').value = ''; document.getElementById('dateFilter').value = '';
            if (appState.isAdmin) { document.getElementById('filterCategory').value = 'all'; document.getElementById('filterZone').value = 'all'; document.getElementById('filterCommunity').innerHTML = '<option value="all">All Communities</option>'; document.getElementById('filterOperator').value = 'all'; }
            filterTable();
        }

        // --- Entry Flow ---
        function updateBandPreview() {
            const start = parseInt(document.getElementById('startBand').value) || 0;
            const count = parseInt(document.getElementById('qty').value) || 0;
            const container = document.getElementById('bandsPreview'); container.innerHTML = '';
            for (let i = 0; i < count; i++) container.innerHTML += `<div class="band-block"><div class="band-num">${start + i}</div><div style="font-size:10px; font-weight:700;">BAND #</div></div>`;
            document.getElementById('calcTotal').textContent = (count * 50).toLocaleString();
            document.getElementById('qtyDisplay').textContent = `${count} bands √ó ‚Çπ50`;
        }

        document.getElementById('entryForm').onsubmit = async (e) => {
            e.preventDefault();
            const start = parseInt(document.getElementById('startBand').value);
            const count = parseInt(document.getElementById('qty').value);
            if (!count) return showToast("Please enter quantity", true);
            
            const bands = []; for(let i=0; i<count; i++) bands.push(start+i);
            const payload = { userId: appState.currentUser, name: document.getElementById('recName').value, zone: document.getElementById('recZone').value, community: document.getElementById('recComm').value, bands, amountPerBand: 50 };
            
            const res = await fetch(`${API_URL}/save-entry`, { method: 'POST', body: JSON.stringify(payload) });
            const result = await res.json();
            
            if(res.status === 409) {
                showToast(`DUPLICATE DETECTED: Band(s) ${result.duplicateBands.map(d=>d.bandNo).join(', ')} already entered!`, true);
            } else if(result.success) {
                showToast("Entry Saved Successfully", false);
                document.getElementById('entryForm').reset();
                document.getElementById('startBand').value = start + count;
                updateBandPreview();
                loadEntries();
            } else {
                showToast(result.error || "Save Failed", true);
            }
        };

        // --- Admin UI Logic ---
        function handleRoleChange(role) {
            const zF = document.getElementById('zoneSubField'); const uS = document.getElementById('newUsername'); const zS = document.getElementById('newUserZone');
            if (role === 'Zone') { zF.style.display = 'block'; zS.innerHTML = '<option value="">Select Zone</option>' + ['1','2','3A','3B','4A','4B'].map(z => `<option value="${z}">${z}</option>`).join(''); uS.innerHTML = '<option value="">Select Zone Group</option>'; }
            else { zF.style.display = 'none'; uS.innerHTML = `<option value="${role} ID 1">${role} ID 1</option><option value="${role} ID 2">${role} ID 2</option>`; }
        }

        function populateCommunityUsernames(z) { const s = document.getElementById('newUsername'); s.innerHTML = '<option value="">Select Profile</option>'; if(communitiesMap[z]) communitiesMap[z].forEach(c => s.innerHTML += `<option value="${c}">${c}</option>`); }

        async function submitNewUser() { const payload = { username: document.getElementById('newUsername').value, role: document.getElementById('newRole').value, userZone: document.getElementById('newUserZone').value || null, password: 'olep@2026' }; if(await fetch(`${API_URL}/manage-users`, { method: 'POST', body: JSON.stringify(payload) })) { showToast("Profile Created"); closeModal('addUserModal'); init(); } }

        async function renderManageUsersList() {
            const res = await fetch(`${API_URL}/manage-users`); const d = await res.json();
            document.getElementById('userListBody').innerHTML = d.data.map(u => u.isAdmin ? '' : `<div style="display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid #f0f0f0;"><div><strong>${u.username}</strong><br><span style="font-size:10px; color:#999;">${u.role} | ${u.userZone || ''} | Pass: ${u.password}</span></div><div class="action-btns"><button class="btn btn-sm btn-secondary" onclick="openProfileEdit('${u._id}','${u.username}','${u.password}','${u.role}')">Edit</button><button class="btn btn-sm btn-danger" onclick="deleteUser('${u.username}')">Del</button></div></div>`).join('');
            openModal('userManageModal');
        }

        function openProfileEdit(id, n, p, r) { document.getElementById('editUserId').value = id; document.getElementById('editProfileName').value = n; document.getElementById('editProfilePass').value = p; document.getElementById('editProfileRole').value = r; openModal('editProfileModal'); }
        async function saveUserProfile() { const payload = { id: document.getElementById('editUserId').value, username: document.getElementById('editProfileName').value, password: document.getElementById('editProfilePass').value, role: document.getElementById('editProfileRole').value }; await fetch(`${API_URL}/manage-users`, { method: 'PUT', body: JSON.stringify(payload) }); closeModal('editProfileModal'); renderManageUsersList(); init(); }
        async function deleteUser(u) { if(confirm(`Delete ${u}?`)) { await fetch(`${API_URL}/manage-users?username=${u}`, { method: 'DELETE' }); renderManageUsersList(); init(); } }

        // --- Shared Helpers ---
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function showPage(pId) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(pId).classList.add('active'); document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); document.getElementById('tab-'+pId.replace('Page','')).classList.add('active'); if(pId === 'dataPage') loadEntries(); }
        
        function showToast(m, isError = false) { 
            const t = document.getElementById('toast'); 
            t.textContent = m; 
            t.className = `toast ${isError ? 'error' : 'success'}`;
            t.style.display = 'block'; 
            setTimeout(() => t.style.display = 'none', 4000); 
        }

        function populateCommunities(tId, z) { const s = document.getElementById(tId); s.innerHTML = '<option value="">Select Community</option>'; if(communitiesMap[z]) communitiesMap[z].forEach(c => s.innerHTML += `<option value="${c}">${c}</option>`); }
        function openEditEntry(id, b, n, z, c) { document.getElementById('editEntryId').value = id; document.getElementById('eBand').value = b; document.getElementById('eName').value = n; document.getElementById('eZone').value = z; populateCommunities('eComm', z); setTimeout(() => document.getElementById('eComm').value = c, 100); openModal('editEntryModal'); }
        async function submitEntryUpdate() { const payload = { id: document.getElementById('editEntryId').value, newBandNo: parseInt(document.getElementById('eBand').value), name: document.getElementById('eName').value, zone: document.getElementById('eZone').value, community: document.getElementById('eComm').value, amount: 50 }; if(await fetch(`${API_URL}/update-entry`, { method: 'PUT', body: JSON.stringify(payload), headers: {'Content-Type': 'application/json'} })) { closeModal('editEntryModal'); loadEntries(); showToast("Record Updated"); } }
        async function deleteEntry(id) { if(confirm("Delete this record?")) { await fetch(`${API_URL}/delete-entry?id=${id}`, { method: 'DELETE' }); loadEntries(); showToast("Deleted"); } }
        async function clearDatabase() { if(prompt("Type 'admin123' to confirm wipe:") === 'admin123') { await fetch(`${API_URL}/delete-entry?userId=all`, { method: 'DELETE' }); loadEntries(); showToast("All Records Wiped"); } }
        
        function exportCSV() {
            let csv = "Band #,Recipient,Zone,Community,Amount,Date,Time,Operator\n";
            appState.entries.forEach(e => {
                const dt = new Date(e.createdAt);
                csv += `${e.bandNo},"${e.name}",${e.zone},"${e.community}",${e.amount},${dt.toLocaleDateString()},${dt.toLocaleTimeString()},${e.userId}\n`;
            });
            const link = document.createElement("a"); link.setAttribute("href", encodeURI("data:text/csv;charset=utf-8," + csv)); link.setAttribute("download", `MFN2026_Report.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        init();
    </script>
</body>
</html>