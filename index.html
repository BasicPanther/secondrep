<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Band Entry Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .user-role-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #64748b;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #4f46e5;
            background: white;
            border-bottom-color: #4f46e5;
        }

        .tab:hover {
            background: #e2e8f0;
        }

        .tab-content {
            padding: 40px;
            min-height: 500px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .login-section {
            max-width: 500px;
            margin: 0 auto;
            text-align: center;
        }

        .user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .user-card {
            background: #f8fafc;
            padding: 30px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
            border-color: #4f46e5;
        }

        .user-card.selected {
            border-color: #4f46e5;
            background: linear-gradient(135deg, #eef2ff, #f0f9ff);
            transform: scale(1.02);
        }

        .user-role {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.2rem;
        }

        .user-name {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .password-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1.1rem;
            margin: 20px 0;
            transition: border-color 0.3s ease;
        }

        .password-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .login-btn {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .entry-form {
            background: #f8fafc;
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .form-group input, .form-group select {
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .save-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 20px 50px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            grid-column: 1 / -1;
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }

        .entries-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .entry-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 5px solid #4f46e5;
            transition: all 0.3s ease;
        }

        .entry-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.12);
        }

        .entry-date {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 10px;
        }

        .entry-song {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .entry-band {
            font-size: 1.1rem;
            color: #4f46e5;
            font-weight: 600;
        }

        .entry-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        .settings-section {
            max-width: 800px;
            margin: 0 auto;
        }

        .manage-users-btn {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
            display: block;
        }

        .manage-users-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(245, 158, 11, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        }

        .modal h3 {
            margin-bottom: 25px;
            color: #1e293b;
            font-size: 1.5rem;
        }

        .role-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #f0f9ff;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            margin: 10px 0;
        }

        .role-zonal { background: #dbeafe; color: #1e40af; }
        .role-desk { background: #fef3c7; color: #92400e; }
        .role-church { background: #f3e8ff; color: #7c3aed; }
        .role-unassigned { background: #f1f5f9; color: #64748b; }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(79, 70, 229, 0.4);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .users-table th {
            background: #f8fafc;
            padding: 20px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e2e8f0;
        }

        .users-table td {
            padding: 20px;
            border-bottom: 1px solid #f1f5f9;
        }

        .users-table tr:hover {
            background: #f8fafc;
        }

        .status-admin {
            background: #fef3c7;
            color: #92400e;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-user {
            background: #dbeafe;
            color: #1e40af;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .no-data svg {
            width: 80px;
            height: 80px;
            opacity: 0.5;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #64748b;
        }

        .error {
            background: #fef2f2;
            color: #dc2626;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 5px solid #ef4444;
        }

        .success {
            background: #f0fdf4;
            color: #166534;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 5px solid #10b981;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .entries-list {
                grid-template-columns: 1fr;
            }
            
            .user-role-badge {
                position: static;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-role-badge" id="userRoleBadge" style="display: none;">
                <span id="roleIcon"></span>
                <span id="roleText"></span>
            </div>
            <h1>Band Entry System</h1>
            <p>Manage band entries efficiently with role-based access</p>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="login">Login</div>
            <div class="tab" data-tab="entries">Entries</div>
            <div class="tab" data-tab="settings" style="display: none;" id="settingsTab">Settings</div>
        </div>

        <!-- Login Tab -->
        <div class="tab-content active" id="loginTab">
            <div class="login-section">
                <h2 style="margin-bottom: 30px; color: #1e293b;">Select User</h2>
                <div class="user-grid" id="userGrid">
                    <div class="loading">Loading users...</div>
                </div>
                <div style="margin-top: 30px;">
                    <input type="password" class="password-input" id="passwordInput" placeholder="Enter password" disabled>
                    <button class="login-btn" id="loginBtn" disabled>Login</button>
                </div>
            </div>
        </div>

        <!-- Entries Tab -->
        <div class="tab-content" id="entriesTab">
            <div class="entry-form">
                <h2 style="margin-bottom: 30px; color: #1e293b;">Add New Entry</h2>
                <form id="entryForm" class="form-grid">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="entryDate" required>
                    </div>
                    <div class="form-group">
                        <label>Song</label>
                        <input type="text" id="songName" placeholder="Song title" required>
                    </div>
                    <div class="form-group">
                        <label>Band</label>
                        <input type="text" id="bandName" placeholder="Band name" required>
                    </div>
                    <button type="submit" class="save-btn">Save Entry</button>
                </form>
            </div>
            <div id="entriesContainer">
                <div class="loading">Loading entries...</div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content" id="settingsTabContent">
            <div class="settings-section">
                <h2 style="margin-bottom: 20px; color: #1e293b;">Admin Settings</h2>
                <button class="manage-users-btn" onclick="openUserManagement()">Manage Users</button>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div class="modal" id="userManagementModal">
        <div class="modal-content">
            <h3 id="modalTitle">Manage Users</h3>
            <div id="usersTableContainer">
                <div class="loading">Loading users...</div>
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeUserManagement()">Close</button>
            </div>
        </div>
    </div>

    <!-- Create/Edit User Modal -->
    <div class="modal" id="userEditModal">
        <div class="modal-content">
            <h3 id="userModalTitle">Create New User</h3>
            <form id="userForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="userUsername" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="userPassword" required>
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="userRole" required>
                        <option value="">Select Role</option>
                        <option value="zonal">üìç Zonal Coordinators</option>
                        <option value="desk">üñ•Ô∏è Desk</option>
                        <option value="church">‚õ™ Church Office</option>
                        <option value="unassigned">‚ùì Unassigned</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn-secondary" onclick="closeUserEdit()">Cancel</button>
                    <button type="submit" class="btn-primary" id="userFormBtn">Create User</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        let editingUserId = null;
        let users = [];
        let entries = [];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            setMinDate();
            loadUsers();
            setupEventListeners();
        });

        function setMinDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('entryDate').min = today;
            document.getElementById('entryDate').value = today;
        }

        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });

            // User selection
            document.addEventListener('click', function(e) {
                if (e.target.closest('.user-card')) {
                    selectUser(e.target.closest('.user-card'));
                }
            });

            // Login
            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });

            // Entry form
            document.getElementById('entryForm').addEventListener('submit', saveEntry);

            // User form
            document.getElementById('userForm').addEventListener('submit', saveUser);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            document.querySelector([data-tab="${tabName}"]).classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            if (tabName === 'entries' && currentUser) {
                loadEntries();
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/.netlify/functions/manage-users?action=getUsers');
                const data = await response.json();

                if (data.success) {
                    users = data.users;
                    renderUsers();
                } else {
                    showError('Failed to load users: ' + data.error);
                }
            } catch (error) {
                showError('Network error loading users');
            }
        }

        function renderUsers() {
            const container = document.getElementById('userGrid');
            container.innerHTML = '';

            if (users.length === 0) {
                container.innerHTML = '<div class="no-data"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg><h3>No users found</h3><p>Admin can create users in Settings</p></div>';
                return;
            }

            users.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                userCard.dataset.username = user.username;
                
                const role = user.role || 'unassigned';
                const roleConfig = {
                    zonal: { icon: 'üìç', text: 'Zonal Coordinator', class: 'role-zonal' },
                    desk: { icon: 'üñ•Ô∏è', text: 'Desk', class: 'role-desk' },
                    church: { icon: '‚õ™', text: 'Church Office', class: 'role-church' },
                    unassigned: { icon: '‚ùì', text: 'Unassigned', class: 'role-unassigned' }
                };

                const roleInfo = roleConfig[role];
                
                userCard.innerHTML = `
                    <div class="user-role">${roleInfo.icon}</div>
                    <div class="user-name">${user.username}</div>
                    <div class="role-badge ${roleInfo.class}">${roleInfo.text}</div>
                `;
                container.appendChild(userCard);
            });
        }

        function selectUser(card) {
            document.querySelectorAll('.user-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            
            const username = card.dataset.username;
            document.getElementById('passwordInput').disabled = false;
            document.getElementById('passwordInput').focus();
            document.getElementById('loginBtn').disabled = false;
            document.getElementById('loginBtn').textContent = Login as ${username};
        }

        async function login() {
            const username = document.querySelector('.user-card.selected')?.dataset.username;
            const password = document.getElementById('passwordInput').value;

            if (!username || !password) {
                showError('Please select a user and enter password');
                return;
            }

            try {
                const response = await fetch('/.netlify/functions/manage-users?action=login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();

                if (data.success) {
                    currentUser = data.user;
                    showUserInterface();
                } else {
                    showError(data.error || 'Login failed');
                    document.getElementById('passwordInput').value = '';
                }
            } catch (error) {
                showError('Login failed - network error');
            }
        }

        function showUserInterface() {
            // Show role badge
            const roleBadge = document.getElementById('userRoleBadge');
            const roleIcon = document.getElementById('roleIcon');
            const roleText = document.getElementById('roleText');
            
            const roleConfig = {
                zonal: { icon: 'üìç', text: 'Zonal Coordinator' },
                desk: { icon: 'üñ•Ô∏è', text: 'Desk' },
                church: { icon: '‚õ™', text: 'Church Office' },
                unassigned: { icon: '‚ùì', text: 'Unassigned' }
            };
            
            const role = currentUser.role || 'unassigned';
            const roleInfo = roleConfig[role];
            
            roleIcon.textContent = roleInfo.icon;
            roleText.textContent = roleInfo.text;
            roleBadge.style.display = 'inline-flex';

            // Show settings tab if admin
            if (currentUser.isAdmin) {
                document.getElementById('settingsTab').style.display = 'block';
            }

            // Switch to entries tab
            switchTab('entries');
            loadEntries();
        }

        async function saveEntry(e) {
            e.preventDefault();
            
            const entry = {
                date: document.getElementById('entryDate').value,
                song: document.getElementById('songName').value,
                band: document.getElementById('bandName').value,
                userId: currentUser._id,
                username: currentUser.username
            };

            try {
                const response = await fetch('/.netlify/functions/save-entry', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(entry)
                });
                const data = await response.json();

                if (data.success) {
                    document.getElementById('entryForm').reset();
                    setMinDate();
                    showSuccess('Entry saved successfully!');
                    loadEntries();
                } else {
                    showError(data.error || 'Failed to save entry');
                }
            } catch (error) {
                showError('Network error saving entry');
            }
        }

        async function loadEntries() {
            try {
                const response = await fetch('/.netlify/functions/get-entries?userId=' + currentUser._id);
                const data = await response.json();

                if (data.success) {
                    entries = data.entries;
                    renderEntries();
                } else {
                    showError('Failed to load entries');
                }
            } catch (error) {
                showError('Network error loading entries');
            }
        }

        function renderEntries() {
            const container = document.getElementById('entriesContainer');
            
            if (entries.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                        <h3>No entries yet</h3>
                        <p>Create your first entry above</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <h3 style="margin-bottom: 20px; color: #1e293b;">${entries.length} Entries</h3>
                <div class="entries-list">
                    ${entries.map(entry => `
                        <div class="entry-card">
                            <div class="entry-date">${new Date(entry.date).toLocaleDateString('en-IN')}</div>
                            <div class="entry-song">${entry.song}</div>
                            <div class="entry-band">${entry.band}</div>
                            <div class="entry-actions">
                                <button class="delete-btn" onclick="deleteEntry('${entry._id}')">Delete</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function deleteEntry(entryId) {
            if (!confirm('Are you sure you want to delete this entry?')) return;

            try {
                const response = await fetch('/.netlify/functions/delete-entry?id=' + entryId, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    showSuccess('Entry deleted!');
                    loadEntries();
                } else {
                    showError('Failed to delete entry');
                }
            } catch (error) {
                showError('Network error deleting entry');
            }
        }

        function openUserManagement() {
            if (!currentUser.isAdmin) return;
            
            document.getElementById('modalTitle').textContent = 'Manage Users';
            document.getElementById('userManagementModal').classList.add('active');
            loadUsersTable();
        }

        function closeUserManagement() {
            document.getElementById('userManagementModal').classList.remove('active');
        }

        async function loadUsersTable() {
            const container = document.getElementById('usersTableContainer');
            container.innerHTML = '<div class="loading">Loading...</div>';

            try {
                const response = await fetch('/.netlify/functions/manage-users?action=getUsers');
                const data = await response.json();

                if (data.success) {
                    renderUsersTable(data.users);
                } else {
                    container.innerHTML = '<div class="error">Failed to load users</div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="error">Network error</div>';
            }
        }

        function renderUsersTable(usersData) {
            const container = document.getElementById('usersTableContainer');
            
            if (usersData.length === 0) {
                container.innerHTML = '<div class="no-data">No users found</div>';
                return;
            }

            const roleConfig = {
                zonal: 'üìç Zonal Coordinators',
                desk: 'üñ•Ô∏è Desk',
                church: '‚õ™ Church Office',
                unassigned: '‚ùì Unassigned'
            };

            container.innerHTML = `
                <div style="margin-bottom: 20px; display: flex; gap: 10px; justify-content: space-between; align-items: center;">
                    <h4>${usersData.length} Users</h4>
                    <button class="btn-primary" onclick="openUserEdit()">Create New User</button>
                </div>
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${usersData.map(user => {
                            const role = user.role || 'unassigned';
                            const roleDisplay = roleConfig[role];
                            const statusClass = user.isAdmin ? 'status-admin' : 'status-user';
                            const statusText = user.isAdmin ? 'Admin' : 'User';
                            const createdDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString('en-IN') : 'Unknown';
                            
                            return `
                                <tr>
                                    <td><strong>${user.username}</strong></td>
                                    <td><span class="role-badge role-${role}">${roleDisplay}</span></td>
                                    <td><span class="status-${statusClass}">${statusText}</span></td>
                                    <td>${createdDate}</td>
                                    <td>
                                        <button class="btn-primary" style="margin-right: 10px;" onclick="editUser('${user._id}')">Edit</button>
                                        <button class="btn-danger" onclick="deleteUser('${user._id}', '${user.username}')">Delete</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function openUserEdit(userId = null) {
            editingUserId = userId;
            
            if (userId) {
                // Edit mode - load user data
                const user = users.find(u => u._id === userId);
                if (user) {
                    document.getElementById('userModalTitle').textContent = 'Edit User';
                    document.getElementById('userUsername').value = user.username;
                    document.getElementById('userPassword').placeholder = 'Leave blank to keep current';
                    document.getElementById('userPassword').required = false;
                    document.getElementById('userRole').value = user.role || 'unassigned';
                    document.getElementById('userFormBtn').textContent = 'Save Changes';
                }
            } else {
                // Create mode
                document.getElementById('userForm').reset();
                document.getElementById('userModalTitle').textContent = 'Create New User';
                document.getElementById('userPassword').placeholder = 'Enter password';
                document.getElementById('userPassword').required = true;
                document.getElementById('userFormBtn').textContent = 'Create User';
            }
            
            document.getElementById('userEditModal').classList.add('active');
        }

        function closeUserEdit() {
            document.getElementById('userEditModal').classList.remove('active');
            editingUserId = null;
        }

        async function saveUser(e) {
            e.preventDefault();
            
            const username = document.getElementById('userUsername').value;
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;

            const userData = {
                username,
                role,
                ...(password && { password }) // Only send password if provided
            };

            try {
                const action = editingUserId ? 'updateUser' : 'createUser';
                const response = await fetch('/.netlify/functions/manage-users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, userId: editingUserId, ...userData })
                });
                const data = await response.json();

                if (data.success) {
                    showSuccess(editingUserId ? 'User updated successfully!' : 'User created successfully!');
                    closeUserEdit();
                    loadUsersTable();
                    loadUsers(); // Refresh main user list
                } else {
                    showError(data.error || 'Failed to save user');
                }
            } catch (error) {
                showError('Network error saving user');
            }
        }

        async function deleteUser(userId, username) {
            if (!confirm(Delete user "${username}" and all their entries? This cannot be undone.)) return;

            try {
                const response = await fetch('/.netlify/functions/manage-users', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'deleteUser', userId })
                });
                const data = await response.json();

                if (data.success) {
                    showSuccess('User deleted successfully!');
                    loadUsersTable();
                    loadUsers();
                } else {
                    showError(data.error || 'Failed to delete user');
                }
            } catch (error) {
                showError('Network error deleting user');
            }
        }

        function editUser(userId) {
            openUserEdit(userId);
        }

        function showError(message) {
            const existing = document.querySelector('.error');
            if (existing) existing.remove();
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.tab-content.active').insertBefore(errorDiv, document.querySelector('.tab-content.active').firstChild);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const existing = document.querySelector('.success');
            if (existing) existing.remove();
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.querySelector('.tab-content.active').insertBefore(successDiv, document.querySelector('.tab-content.active').firstChild);
            
            setTimeout(() => successDiv.remove(), 3000);
        }

        // Auto-logout after 30 minutes of inactivity
        let inactivityTimer;
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                if (currentUser) {
                    alert('Session expired due to inactivity. Please login again.');
                    logout();
                }
            }, 30 * 60 * 1000);
        }

        function logout() {
            currentUser = null;
            document.getElementById('userRoleBadge').style.display = 'none';
            document.getElementById('settingsTab').style.display = 'none';
            document.getElementById('passwordInput').value = '';
            document.querySelector('.user-card.selected')?.classList.remove('selected');
            document.getElementById('passwordInput').disabled = true;
            document.getElementById('loginBtn').disabled = true;
            switchTab('login');
        }

        // Reset inactivity timer on user activity
        ['click', 'keypress', 'mousemove'].forEach(event => {
            document.addEventListener(event, resetInactivityTimer, true);
        });
    </script>
</body>
</html>